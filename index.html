<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GeriatriCare AI Pro – RSUD Pasar Rebo</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22GeriatriCare%20AI%20Pro%22,%22short_name%22:%22GeriatriCare%22,%22display%22:%22standalone%22,%22background_color%22:%22#ffffff%22,%22theme_color%22:%22#00796b%22,%22start_url%22:%22/%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='40' fill='%2300796b'/%3E%3Ctext x='50' y='60' text-anchor='middle' fill='white' font-size='40'%3E🏥%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22}]}"/>
  <meta name="theme-color" content="#00796b"/>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { 
        extend: { 
          fontFamily: { poppins: ['Poppins', 'sans-serif'] },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-up': 'slideUp 0.6s ease-out',
            'bounce-gentle': 'bounceGentle 2s infinite',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
            bounceGentle: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } }
          }
        } 
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: 'Poppins', sans-serif; }
    .glass { 
      background: rgba(255, 255, 255, 0.25); 
      backdrop-filter: blur(16px) saturate(180%); 
      border: 1px solid rgba(255, 255, 255, 0.3); 
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    .dark .glass { 
      background: rgba(15, 23, 42, 0.6); 
      border: 1px solid rgba(255, 255, 255, 0.1); 
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    .gradient-text {
      background: linear-gradient(135deg, #14b8a6, #10b981, #84cc16, #eab308);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .chat-user { background: linear-gradient(135deg, #ec4899, #ef4444); }
    .chat-bot { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
    .typing-indicator::after {
      content: '...';
      animation: blink 1.5s infinite;
    }
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }
    .feature-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.2));
    }
    .feature-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
  </style>
</head>

<body class="bg-gradient-to-br from-cyan-50 via-blue-50 via-green-50 to-yellow-50 dark:from-slate-900 dark:via-gray-900 dark:to-black transition-all duration-700">

<!-- HEADER -->
<header class="sticky top-0 z-40 glass shadow-xl animate-slide-up">
  <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
    <div class="flex items-center space-x-3">
      <div class="text-3xl animate-bounce-gentle">🏥</div>
      <h1 class="text-xl md:text-2xl font-bold gradient-text">
        GeriatriCare AI Pro
      </h1>
    </div>
    <div class="flex items-center space-x-4">
      <div class="flex items-center space-x-2">
        <button id="fontDecrease" class="text-teal-600 dark:text-yellow-300 text-sm font-bold px-2 py-1 rounded hover:bg-white/20" aria-label="Kecilkan huruf">A-</button>
        <button id="fontIncrease" class="text-teal-600 dark:text-yellow-300 text-lg font-bold px-2 py-1 rounded hover:bg-white/20" aria-label="Besarkan huruf">A+</button>
      </div>
      <button id="themeToggle" class="text-2xl hover:scale-110 transition-transform" aria-label="Ganti tema">🌙</button>
      <button id="speechToggle" class="text-xl hover:scale-110 transition-transform" aria-label="Suara" title="Toggle Text-to-Speech">🔊</button>
    </div>
  </div>
</header>

<!-- HERO SECTION -->
<section class="max-w-6xl mx-auto px-4 py-12 text-center animate-fade-in">
  <h2 class="text-4xl md:text-5xl font-extrabold mb-4 animate-slide-up">
    <span class="gradient-text">AI-Powered Healthcare</span>
    <br/>
    <span class="text-gray-700 dark:text-gray-300">for Elderly Care</span>
  </h2>
  <p class="text-lg text-gray-600 dark:text-gray-300 mb-6 max-w-2xl mx-auto">
    Platform kesehatan lansia dengan AI natural, visualisasi interaktif, dan layanan terintegrasi.
  </p>
  <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
    <button onclick="openChat()" class="bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 text-white px-6 py-3 rounded-full shadow-2xl hover:scale-105 transition-all duration-300 font-semibold">
      💬 Konsultasi AI
    </button>
    <button onclick="scrollToScanner()" class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-6 py-3 rounded-full shadow-xl hover:scale-105 transition-all duration-300 font-semibold">
      🔍 Health Check
    </button>
  </div>
</section>

<!-- AI HEALTH SCANNER -->
<section id="scanner" class="max-w-4xl mx-auto px-4 mb-12 animate-slide-up">
  <div class="glass rounded-3xl p-6 shadow-2xl">
    <div class="text-center mb-4">
      <h3 class="text-xl font-bold gradient-text mb-2">🔍 AI Health Risk Scanner</h3>
      <p class="text-sm text-gray-600 dark:text-gray-300">Analisis risiko kesehatan dengan AI</p>
    </div>
    
    <form onsubmit="event.preventDefault(); runScanner();" class="space-y-4">
      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <input id="age" type="number" min="50" max="120" placeholder="Usia (tahun)" required 
                 class="w-full p-3 rounded-xl border dark:bg-gray-700 focus:border-teal-500 transition-colors"/>
        </div>
        <div>
          <select id="gender" required class="w-full p-3 rounded-xl border dark:bg-gray-700 focus:border-teal-500 transition-colors">
            <option value="">Jenis Kelamin</option>
            <option value="male">Laki-laki</option>
            <option value="female">Perempuan</option>
          </select>
        </div>
        <div>
          <select id="condition" required class="w-full p-3 rounded-xl border dark:bg-gray-700 focus:border-teal-500 transition-colors">
            <option value="">Kondisi Kesehatan</option>
            <option value="hypertension">Hipertensi</option>
            <option value="diabetes">Diabetes</option>
            <option value="heart">Penyakit Jantung</option>
            <option value="multiple">Multiple Conditions</option>
            <option value="none">Sehat</option>
          </select>
        </div>
      </div>
      
      <div>
        <select id="activity" required class="w-full p-3 rounded-xl border dark:bg-gray-700 focus:border-teal-500 transition-colors">
          <option value="">Tingkat Aktivitas Fisik</option>
          <option value="low">Rendah (jarang olahraga)</option>
          <option value="medium">Sedang (2-3x/minggu)</option>
          <option value="high">Tinggi (rutin setiap hari)</option>
        </select>
      </div>
      
      <button type="submit" class="w-full bg-gradient-to-r from-teal-600 to-emerald-500 text-white py-3 rounded-xl shadow-lg hover:scale-[1.02] transition-all duration-300 font-semibold">
        🎯 Analisis Sekarang
      </button>
    </form>
    
    <div id="scanResult" class="mt-6 hidden animate-fade-in"></div>
  </div>
</section>

<!-- FEATURE CARDS -->
<section class="max-w-6xl mx-auto px-4 mb-12">
  <h3 class="text-2xl font-bold text-center mb-8 gradient-text">Layanan Terintegrasi</h3>
  <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
    <div class="feature-card glass rounded-2xl p-4 text-center">
      <div class="text-3xl mb-2">👥</div>
      <h4 class="font-bold mb-1 text-gray-800 dark:text-gray-200">Tim Geriatri</h4>
      <p class="text-xs text-gray-600 dark:text-gray-300">Spesialis lansia terpadu</p>
    </div>
    
    <div class="feature-card glass rounded-2xl p-4 text-center">
      <div class="text-3xl mb-2">🧠</div>
      <h4 class="font-bold mb-1 text-gray-800 dark:text-gray-200">KELD</h4>
      <p class="text-xs text-gray-600 dark:text-gray-300">Evaluasi komprehensif</p>
    </div>
    
    <div class="feature-card glass rounded-2xl p-4 text-center">
      <div class="text-3xl mb-2">⚡</div>
      <h4 class="font-bold mb-1 text-gray-800 dark:text-gray-200">Registrasi</h4>
      <p class="text-xs text-gray-600 dark:text-gray-300">Pendaftaran cepat</p>
    </div>
    
    <div class="feature-card glass rounded-2xl p-4 text-center">
      <div class="text-3xl mb-2">🏠</div>
      <h4 class="font-bold mb-1 text-gray-800 dark:text-gray-200">Home Care</h4>
      <p class="text-xs text-gray-600 dark:text-gray-300">Layanan rumah</p>
    </div>
    
    <div class="feature-card glass rounded-2xl p-4 text-center">
      <div class="text-3xl mb-2">📱</div>
      <h4 class="font-bold mb-1 text-gray-800 dark:text-gray-200">PWA</h4>
      <p class="text-xs text-gray-600 dark:text-gray-300">Install aplikasi</p>
    </div>
    
    <div class="feature-card glass rounded-2xl p-4 text-center">
      <div class="text-3xl mb-2">🤸</div>
      <h4 class="font-bold mb-1 text-gray-800 dark:text-gray-200">Senam AI</h4>
      <p class="text-xs text-gray-600 dark:text-gray-300">Latihan terpandu</p>
    </div>
    
    <div class="feature-card glass rounded-2xl p-4 text-center">
      <div class="text-3xl mb-2">🛋️</div>
      <h4 class="font-bold mb-1 text-gray-800 dark:text-gray-200">Ruang Nyaman</h4>
      <p class="text-xs text-gray-600 dark:text-gray-300">Area istirahat</p>
    </div>
    
    <div class="feature-card glass rounded-2xl p-4 text-center">
      <div class="text-3xl mb-2">🤖</div>
      <h4 class="font-bold mb-1 text-gray-800 dark:text-gray-200">AI Assistant</h4>
      <p class="text-xs text-gray-600 dark:text-gray-300">Konsultasi 24/7</p>
    </div>
  </div>
</section>

<!-- AI CHAT WIDGET -->
<div id="chatWidget" class="fixed inset-0 bg-black/50 backdrop-blur-md z-50 hidden items-center justify-center p-4">
  <div class="w-full max-w-lg h-[80vh] max-h-[600px] glass rounded-3xl shadow-2xl flex flex-col overflow-hidden">
    <header class="px-4 py-3 bg-gradient-to-r from-purple-600 via-pink-500 to-red-500 text-white flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
        <span class="font-semibold text-sm">🤖 AI Health Assistant</span>
      </div>
      <button onclick="closeChat()" class="text-xl hover:scale-110 transition-transform">✕</button>
    </header>
    
    <div id="chatBody" class="flex-1 p-3 space-y-2 overflow-y-auto bg-gradient-to-b from-gray-50 to-white dark:from-gray-800 dark:to-gray-900">
      <div class="chat-bot text-white p-3 rounded-2xl rounded-bl-md max-w-xs text-sm">
        <p>👋 Halo! Saya AI Assistant kesehatan lansia. Ada yang bisa saya bantu?</p>
      </div>
    </div>
    
    <footer class="p-3 bg-white/50 dark:bg-gray-800/50">
      <div class="flex space-x-2">
        <input id="chatInput" type="text" placeholder="Ketik pertanyaan..." 
               class="flex-1 p-3 rounded-2xl border dark:bg-gray-700 focus:border-purple-500 transition-colors text-sm"/>
        <button onclick="sendMessage()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-3 rounded-2xl hover:scale-105 transition-transform">
          📤
        </button>
      </div>
    </footer>
  </div>
</div>

<!-- FOOTER -->
<footer class="bg-gradient-to-r from-teal-600 to-emerald-600 text-white py-6">
  <div class="max-w-6xl mx-auto px-4 text-center">
    <div class="flex items-center justify-center space-x-2 mb-2">
      <span class="text-xl">🏥</span>
      <span class="font-bold">GeriatriCare AI Pro</span>
    </div>
    <p class="text-sm text-gray-200">© 2025 RSUD Pasar Rebo – Tim Geriatri Inovatif</p>
  </div>
</footer>

<!-- SCRIPTS -->
<script>
/* --- Global Variables --- */
let fontSize = 16;
let speechEnabled = true;
let chartInstance = null;

/* --- Theme & Font Management --- */
const html = document.documentElement;
const themeBtn = document.getElementById('themeToggle');
const speechBtn = document.getElementById('speechToggle');
const fontInc = document.getElementById('fontIncrease');
const fontDec = document.getElementById('fontDecrease');

// Theme toggle
themeBtn.onclick = () => {
  html.classList.toggle('dark');
  const isDark = html.classList.contains('dark');
  themeBtn.innerHTML = isDark ? '☀️' : '🌙';
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
};

// Load saved theme
if (localStorage.getItem('theme') === 'dark') {
  html.classList.add('dark');
  themeBtn.innerHTML = '☀️';
}

// Font size controls
fontInc.onclick = () => {
  if (fontSize < 20) {
    fontSize += 2;
    document.body.style.fontSize = fontSize + 'px';
    localStorage.setItem('fontSize', fontSize);
  }
};

fontDec.onclick = () => {
  if (fontSize > 12) {
    fontSize -= 2;
    document.body.style.fontSize = fontSize + 'px';
    localStorage.setItem('fontSize', fontSize);
  }
};

// Load saved font size
const savedFontSize = localStorage.getItem('fontSize');
if (savedFontSize) {
  fontSize = parseInt(savedFontSize);
  document.body.style.fontSize = fontSize + 'px';
}

// Speech toggle
speechBtn.onclick = () => {
  speechEnabled = !speechEnabled;
  speechBtn.innerHTML = speechEnabled ? '🔊' : '🔇';
};

/* --- Text-to-Speech Function --- */
function speakText(text) {
  if (!speechEnabled || !window.speechSynthesis) return;
  
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'id-ID';
  utterance.rate = 0.8;
  utterance.pitch = 1;
  window.speechSynthesis.speak(utterance);
}

/* --- Health Scanner --- */
function scrollToScanner() {
  document.getElementById('scanner').scrollIntoView({ behavior: 'smooth' });
}

function runScanner() {
  const age = parseInt(document.getElementById('age').value);
  const gender = document.getElementById('gender').value;
  const condition = document.getElementById('condition').value;
  const activity = document.getElementById('activity').value;
  
  if (!age || !gender || !condition || !activity) {
    alert('🚨 Mohon lengkapi semua data!');
    return;
  }
  
  // Calculate risk score
  let riskScore = 0;
  
  // Age factor
  if (age >= 80) riskScore += 35;
  else if (age >= 70) riskScore += 25;
  else if (age >= 60) riskScore += 15;
  
  // Gender factor
  if (gender === 'male' && age > 65) riskScore += 5;
  
  // Condition factor
  const conditionScores = {
    'multiple': 40, 'heart': 35, 'diabetes': 30, 
    'hypertension': 25, 'none': 0
  };
  riskScore += conditionScores[condition] || 0;
  
  // Activity factor
  const activityScores = { 'low': 20, 'medium': 10, 'high': 0 };
  riskScore += activityScores[activity] || 0;
  
  riskScore = Math.min(riskScore, 100);
  
  displayScanResult(riskScore);
}

function displayScanResult(score) {
  const resultDiv = document.getElementById('scanResult');
  
  // Determine risk level and colors
  let level, colors, advice;
  if (score >= 70) {
    level = 'TINGGI';
    colors = ['#ef4444', '#fca5a5'];
    advice = 'Konsultasi dokter segera, monitor vital signs rutin';
  } else if (score >= 40) {
    level = 'SEDANG';
    colors = ['#f97316', '#fed7aa'];
    advice = 'Kontrol rutin 3 bulan, perbaiki gaya hidup';
  } else {
    level = 'RENDAH';
    colors = ['#22c55e', '#bbf7d0'];
    advice = 'Pertahankan pola hidup sehat, check-up tahunan';
  }
  
  resultDiv.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-xl">
      <div class="flex items-center justify-between mb-4">
        <div class="text-center">
          <canvas id="riskChart" class="w-24 h-24 mx-auto"></canvas>
        </div>
        <div class="flex-1 ml-4">
          <div class="text-2xl font-bold ${score >= 70 ? 'text-red-500' : score >= 40 ? 'text-orange-500' : 'text-green-500'}">
            ${score}% 
          </div>
          <div class="text-sm font-semibold text-gray-700 dark:text-gray-300">
            Risiko ${level}
          </div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mt-2">
            ${advice}
          </div>
        </div>
      </div>
      
      <div class="text-center">
        <button onclick="openChat()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-full hover:scale-105 transition-transform text-sm">
          💬 Konsultasi AI
        </button>
      </div>
    </div>
  `;
  
  // Create chart
  setTimeout(() => {
    const canvas = document.getElementById('riskChart');
    if (canvas) {
      if (chartInstance) chartInstance.destroy();
      
      chartInstance = new Chart(canvas, {
        type: 'doughnut',
        data: {
          labels: ['Risiko', 'Sehat'],
          datasets: [{
            data: [score, 100 - score],
            backgroundColor: colors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          cutout: '70%'
        }
      });
    }
  }, 100);
  
  resultDiv.classList.remove('hidden');
  
  // Speak result
  speakText(`Tingkat risiko ${level} sebesar ${score} persen. ${advice}`);
}

/* --- Chat System --- */
const chatWidget = document.getElementById('chatWidget');
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');

function openChat() {
  chatWidget.classList.remove('hidden');
  chatWidget.classList.add('flex');
  chatInput.focus();
}

function closeChat() {
  chatWidget.classList.add('hidden');
  chatWidget.classList.remove('flex');
}

function sendMessage() {
  const message = chatInput.value.trim();
  if (!message) return;
  
  appendMessage('user', message);
  chatInput.value = '';
  
  // Show typing indicator
  const typingDiv = document.createElement('div');
  typingDiv.className = 'chat-bot text-white p-3 rounded-2xl rounded-bl-md max-w-xs typing-indicator text-sm';
  typingDiv.innerHTML = '<p>Mengetik...</p>';
  chatBody.appendChild(typingDiv);
  chatBody.scrollTop = chatBody.scrollHeight;
  
  // Get AI response
  setTimeout(() => {
    typingDiv.remove();
    const response = getAIResponse(message);
    appendMessage('bot', response);
    speakText(response);
  }, 1500);
}

function appendMessage(sender, text) {
  const messageDiv = document.createElement('div');
  messageDiv.className = sender === 'user' 
    ? 'chat-user text-white p-3 rounded-2xl rounded-br-md max-w-xs ml-auto text-sm' 
    : 'chat-bot text-white p-3 rounded-2xl rounded-bl-md max-w-xs text-sm';
  
  const p = document.createElement('p');
  p.textContent = text;
  messageDiv.appendChild(p);
  
  chatBody.appendChild(messageDiv);
  chatBody.scrollTop = chatBody.scrollHeight;
}

function getAIResponse(prompt) {
  const lowerPrompt = prompt.toLowerCase();
  
  // Compact health responses
  if (lowerPrompt.includes('tekanan darah') || lowerPrompt.includes('hipertensi')) {
    return `🩺 Tips hipertensi: kurangi garam, olahraga ringan 30 menit/hari, kelola stress. Target <140/90 mmHg. Jika >180/110 segera ke IGD.`;
  }
  
  if (lowerPrompt.includes('diabetes') || lowerPrompt.includes('gula darah')) {
    return `🍎 Diabetes: cek gula rutin, makan teratur porsi kecil, pilih nasi merah, olahraga setelah makan. Target <180 mg/dL. Konsultasi dokter untuk obat.`;
  }
  
  if (lowerPrompt.includes('jantung') || lowerPrompt.includes('kardio')) {
    return `❤️ Jantung sehat: jalan kaki rutin, diet rendah lemak, tidur cukup, kelola stress. Segera ke RS jika nyeri dada atau sesak berat.`;
  }
  
  if (lowerPrompt.includes('osteoporosis') || lowerPrompt.includes('tulang')) {
    return `🦴 Tulang kuat: kalsium 1200mg/hari, sinar matahari pagi, olahraga beban ringan, hindari rokok. Screening DEXA rutin.`;
  }
  
  if (lowerPrompt.includes('tidur') || lowerPrompt.includes('insomnia')) {
    return `😴 Tidur berkualitas: jadwal tetap 21:00-05:00, kamar gelap sejuk, hindari kafein sore, relaksasi sebelum tidur.`;
  }
  
  if (lowerPrompt.includes('nutrisi') || lowerPrompt.includes('makan')) {
    return `🥗 Nutrisi lansia: 5-6 porsi kecil/hari, protein tinggi, sayur buah, kalsium vitamin D, air putih 8 gelas. Konsultasi ahli gizi.`;
  }
  
  if (lowerPrompt.includes('olahraga') || lowerPrompt.includes('senam')) {
    return `🤸‍♀️ Olahraga aman: pemanasan 5 menit, jalan 30 menit/hari, senam lansia 3x/minggu, latihan keseimbangan. Hentikan jika pusing.`;
  }
  
  if (lowerPrompt.includes('mental') || lowerPrompt.includes('depresi')) {
    return `🧠 Kesehatan mental: tetap bersosialisasi, hobi menyenangkan, bergabung komunitas, latihan kognitif, dukungan keluarga.`;
  }
  
  // General responses
  const responses = [
    `👋 Halo! Ada keluhan kesehatan yang ingin Anda konsultasikan? Saya siap membantu dengan informasi kesehatan lansia.`,
    `🏥 Saya dapat membantu informasi tentang hipertensi, diabetes, jantung, nutrisi, olahraga, dan kesehatan mental lansia.`,
    `💡 Ingat: kontrol rutin, minum obat teratur, pola hidup sehat, tetap aktif. Ada yang spesifik ingin ditanyakan?`
  ];
  
  return responses[Math.floor(Math.random() * responses.length)];
}

// Chat input event listeners
chatInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// Close chat with Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && !chatWidget.classList.contains('hidden') {
    closeChat();
  }
});

/* --- PWA Installation --- */
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
 e.preventDefault();
 deferredPrompt = e;
 
 // Show install button
 const installBtn = document.createElement('button');
 installBtn.className = 'fixed bottom-4 right-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white px-3 py-2 rounded-full shadow-lg hover:scale-105 transition-transform z-40 text-sm';
 installBtn.innerHTML = '📱 Install';
 installBtn.onclick = async () => {
   if (deferredPrompt) {
     deferredPrompt.prompt();
     const { outcome } = await deferredPrompt.userChoice;
     if (outcome === 'accepted') {
       installBtn.remove();
     }
     deferredPrompt = null;
   }
 };
 document.body.appendChild(installBtn);
 
 // Auto-hide after 8 seconds
 setTimeout(() => {
   if (installBtn.parentNode) {
     installBtn.style.opacity = '0.6';
   }
 }, 8000);
});

/* --- Service Worker for Offline Support --- */
if ('serviceWorker' in navigator) {
 window.addEventListener('load', () => {
   const swCode = `
     const CACHE_NAME = 'geriatricare-v2';
     const urlsToCache = [
       '/',
       'https://cdn.tailwindcss.com',
       'https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap',
       'https://cdn.jsdelivr.net/npm/chart.js'
     ];

     self.addEventListener('install', (event) => {
       event.waitUntil(
         caches.open(CACHE_NAME)
           .then((cache) => cache.addAll(urlsToCache))
       );
     });

     self.addEventListener('fetch', (event) => {
       event.respondWith(
         caches.match(event.request)
           .then((response) => {
             if (response) {
               return response;
             }
             return fetch(event.request);
           })
       );
     });
   `;
   
   const blob = new Blob([swCode], { type: 'application/javascript' });
   const swUrl = URL.createObjectURL(blob);
   
   navigator.serviceWorker.register(swUrl)
     .then((registration) => {
       console.log('SW registered successfully');
     })
     .catch((registrationError) => {
       console.log('SW registration failed');
     });
 });
}

/* --- Initialize App --- */
document.addEventListener('DOMContentLoaded', () => {
 // Add smooth animations to feature cards
 const observerOptions = {
   threshold: 0.1,
   rootMargin: '0px 0px -30px 0px'
 };
 
 const observer = new IntersectionObserver((entries) => {
   entries.forEach(entry => {
     if (entry.isIntersecting) {
       entry.target.style.opacity = '1';
       entry.target.style.transform = 'translateY(0)';
     }
   });
 }, observerOptions);
 
 // Observe feature cards
 document.querySelectorAll('.feature-card').forEach(card => {
   card.style.opacity = '0';
   card.style.transform = 'translateY(15px)';
   card.style.transition = 'all 0.5s ease-out';
   observer.observe(card);
 });
});

// Prevent zoom on double tap for better mobile UX
let lastTouchEnd = 0;
document.addEventListener('touchend', (event) => {
 const now = (new Date()).getTime();
 if (now - lastTouchEnd <= 300) {
   event.preventDefault();
 }
 lastTouchEnd = now;
}, false);

// Track feature usage
document.addEventListener('click', (e) => {
 if (e.target.matches('[onclick*="openChat"]')) {
   console.log('Chat opened');
 }
 if (e.target.matches('[onclick*="runScanner"]')) {
   console.log('Health scan initiated');
 }
});

console.log('🏥 GeriatriCare AI Pro v2.0 ready!');
</script>

</body>
</html>
