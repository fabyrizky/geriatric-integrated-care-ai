<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SIGAP GeriatriCare Pro – Platform Kesehatan Geriatri Berbasis AI</title>
  <meta name="description" content="Platform kesehatan geriatri berbasis AI dengan screening 14 item, konsultasi cerdas, dan edukasi berbasis evidence."/>
  
  <!-- PWA Enhanced Manifest -->
  <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22SIGAP%20GeriatriCare%20Pro%22,%22short_name%22:%22SIGAP%22,%22display%22:%22standalone%22,%22background_color%22:%22%230f172a%22,%22theme_color%22:%22%2314b8a6%22,%22start_url%22:%22/%22,%22orientation%22:%22portrait%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='g1' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%2314b8a6'/%3E%3Cstop offset='100%25' style='stop-color:%2310b981'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='256' cy='256' r='230' fill='url(%23g1)'/%3E%3Ctext x='256' y='320' text-anchor='middle' fill='white' font-size='200' font-family='Arial'%3E🏥%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22,%22purpose%22:%22any%20maskable%22}]}"/>
  <meta name="theme-color" content="#14b8a6"/>
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Ccircle cx='256' cy='256' r='230' fill='%2314b8a6'/%3E%3Ctext x='256' y='320' text-anchor='middle' fill='white' font-size='200'%3E🏥%3C/text%3E%3C/svg%3E"/>
  
  <!-- Tailwind CDN with JIT -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { 
        extend: { 
          fontFamily: { 
            poppins: ['Poppins', 'system-ui', 'sans-serif'] 
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-up': 'slideUp 0.6s ease-out',
            'bounce-gentle': 'bounceGentle 2s infinite',
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'shimmer': 'shimmer 2s linear infinite',
            'rotate-3d': 'rotate3d 8s linear infinite'
          },
          backgroundImage: {
            'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
          }
        } 
      }
    }
  </script>
  
  <!-- Google Fonts with display swap -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  
  <!-- Three.js untuk 3D simulasi -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    /* Optimized CSS */
    :root {
      --glass-bg: rgba(255, 255, 255, 0.25);
      --glass-border: rgba(255, 255, 255, 0.3);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      --font-size-base: 18px;
    }
    
    * { 
      -webkit-tap-highlight-color: transparent;
    }
    
    body { 
      font-family: 'Poppins', system-ui, sans-serif; 
      font-size: var(--font-size-base);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    .glass { 
      background: var(--glass-bg); 
      backdrop-filter: blur(16px) saturate(180%); 
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid var(--glass-border); 
      box-shadow: var(--glass-shadow);
    }
    
    .dark {
      --glass-bg: rgba(15, 23, 42, 0.6);
      --glass-border: rgba(255, 255, 255, 0.1);
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #14b8a6 0%, #10b981 25%, #84cc16 50%, #eab308 75%, #f97316 100%);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-size: 200% 200%;
      animation: gradient-shift 3s ease infinite;
    }
    
    @keyframes gradient-shift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    .chat-user { 
      background: linear-gradient(135deg, #ec4899, #ef4444);
      animation: slide-left 0.3s ease-out;
    }
    
    .chat-bot { 
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      animation: slide-right 0.3s ease-out;
    }
    
    .feature-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .feature-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      transform: scale(0);
      transition: transform 0.5s ease;
    }
    
    .feature-card:hover::before {
      transform: scale(1);
    }
    
    .feature-card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(10px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
    
    @keyframes slideUp { 
      from { transform: translateY(20px); opacity: 0; } 
      to { transform: translateY(0); opacity: 1; } 
    }
    
    @keyframes slide-left {
      from { transform: translateX(20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slide-right {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes bounceGentle { 
      0%, 100% { transform: translateY(0); } 
      50% { transform: translateY(-5px); } 
    }
    
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    
    @keyframes rotate3d {
      0% { transform: rotateY(0deg) rotateX(0deg); }
      25% { transform: rotateY(90deg) rotateX(0deg); }
      50% { transform: rotateY(180deg) rotateX(0deg); }
      75% { transform: rotateY(270deg) rotateX(0deg); }
      100% { transform: rotateY(360deg) rotateX(0deg); }
    }
    
    .shimmer {
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      background-size: 1000px 100%;
      animation: shimmer 2s linear infinite;
    }
    
    /* Accessibility */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border-width: 0;
    }
    
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }
    
    /* High contrast mode */
    @media (prefers-contrast: high) {
      .gradient-text {
        background: none;
        -webkit-text-fill-color: currentColor;
        color: #00796b;
      }
      
      .dark .gradient-text {
        color: #4ade80;
      }
    }
    
    /* Print styles */
    @media print {
      body { font-size: 12pt; }
      .no-print { display: none !important; }
      .glass { 
        background: white !important; 
        box-shadow: none !important;
        border: 1px solid #000 !important;
      }
    }
    
    /* Loading skeleton */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.1);
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.3);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(0,0,0,0.5);
    }
    
    /* Focus styles */
    :focus {
      outline: 2px solid #14b8a6;
      outline-offset: 2px;
    }
    
    :focus:not(:focus-visible) {
      outline: none;
    }
    
    /* Knowledge card styles */
    .knowledge-card {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border-left: 4px solid #10b981;
      padding: 1rem;
      margin: 0.5rem 0;
      border-radius: 0.5rem;
      font-size: 0.875rem;
    }
    
    .dark .knowledge-card {
      background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
      border-left-color: #34d399;
    }
    
    .citation {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      color: #0891b2;
      font-size: 0.75rem;
      text-decoration: none;
      transition: color 0.2s;
    }
    
    .citation:hover {
      color: #0e7490;
      text-decoration: underline;
    }
    
    .risk-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-weight: 600;
      animation: pulse-slow 2s infinite;
    }
    
    .risk-high {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #dc2626;
      border: 2px solid #ef4444;
    }
    
    .risk-medium {
      background: linear-gradient(135deg, #fed7aa, #fdba74);
      color: #ea580c;
      border: 2px solid #f97316;
    }
    
    .risk-low {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color: #d97706;
      border: 2px solid #f59e0b;
    }
    
    .risk-minimal {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      color: #059669;
      border: 2px solid #10b981;
    }
    
    /* 3D Container Styles */
    .game-3d-container {
      width: 100%;
      height: 400px;
      position: relative;
      border-radius: 1rem;
      overflow: hidden;
      background: linear-gradient(135deg, #0f172a, #1e293b);
    }
    
    .game-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 10;
    }
    
    .game-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .game-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    
    .game-btn:active {
      transform: scale(0.95);
    }
    
    /* Enhanced button styles for elderly users */
    .elderly-friendly-btn {
      padding: 1rem 1.5rem;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 0.75rem;
      min-height: 3.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.3s;
      border: none;
      cursor: pointer;
    }
    
    .elderly-friendly-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    .elderly-friendly-btn:active {
      transform: translateY(0);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    /* Voice indicator */
    .voice-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .voice-indicator.active {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-cyan-50 via-blue-50 to-green-50 dark:from-slate-900 dark:via-gray-900 dark:to-black transition-all duration-700 min-h-screen">
<!-- Skip to main content -->
<a href="#main" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-teal-600 text-white px-4 py-2 rounded">Lewati ke konten utama</a>
<!-- HEADER -->
<header class="sticky top-0 z-40 glass shadow-xl no-print" role="banner">
  <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
    <div class="flex items-center space-x-3">
      <div class="text-3xl animate-bounce-gentle" aria-hidden="true">🏥</div>
      <div>
        <h1 class="text-xl md:text-2xl font-bold gradient-text">SIGAP GeriatriCare Pro</h1>
        <p class="text-xs text-gray-600 dark:text-gray-400">Platform Kesehatan Geriatri Berbasis AI</p>
      </div>
    </div>
    <nav class="flex items-center space-x-4" role="navigation" aria-label="Navigasi utama">
      <div class="flex items-center space-x-2" role="group" aria-label="Kontrol ukuran font">
        <button id="fontDecrease" class="text-teal-600 dark:text-yellow-300 text-sm font-bold px-2 py-1 rounded hover:bg-white/20 transition-colors" aria-label="Perkecil ukuran font">A-</button>
        <span class="text-xs text-gray-600 dark:text-gray-400" aria-hidden="true">|</span>
        <button id="fontIncrease" class="text-teal-600 dark:text-yellow-300 text-lg font-bold px-2 py-1 rounded hover:bg-white/20 transition-colors" aria-label="Perbesar ukuran font">A+</button>
      </div>
      <button id="themeToggle" class="text-2xl hover:scale-110 transition-transform" aria-label="Ganti tema">🌙</button>
      <button id="speechToggle" class="text-xl hover:scale-110 transition-transform" aria-label="Aktifkan bantuan suara">🔊</button>
    </nav>
  </div>
</header>
<!-- MAIN CONTENT -->
<main id="main" role="main">
  <!-- HERO SECTION -->
  <section class="max-w-6xl mx-auto px-4 py-12 text-center" aria-labelledby="hero-heading">
    <h2 id="hero-heading" class="text-4xl md:text-5xl font-extrabold mb-4">
      <span class="gradient-text">Sistem Geriatri Cerdas Berbasis AI</span>
    </h2>
    <p class="text-lg text-gray-600 dark:text-gray-300 mb-6 max-w-3xl mx-auto">
      Platform komprehensif dengan Asisten AI terlatih, screening geriatri 14 item berbasis evidence, 
      dan grafik pengetahuan medis untuk pelayanan kesehatan lansia optimal.
    </p>
    
    <!-- Quick Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto mb-8">
      <div class="glass rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-teal-600 dark:text-teal-400">98%</div>
        <div class="text-xs text-gray-600 dark:text-gray-400">Akurasi AI</div>
      </div>
      <div class="glass rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">500+</div>
        <div class="text-xs text-gray-600 dark:text-gray-400">Referensi Medis</div>
      </div>
      <div class="glass rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-orange-600 dark:text-orange-400">24/7</div>
        <div class="text-xs text-gray-600 dark:text-gray-400">Dukungan AI</div>
      </div>
      <div class="glass rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-green-600 dark:text-green-400">WCAG AAA</div>
        <div class="text-xs text-gray-600 dark:text-gray-400">Aksesibilitas</div>
      </div>
    </div>
    
    <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
      <button onclick="openScreening()" class="elderly-friendly-btn bg-gradient-to-r from-emerald-500 to-teal-500 text-white shadow-xl hover:shadow-2xl">
        <span aria-hidden="true">📋</span>
        <span>Screening Geriatri Pro</span>
        <span class="opacity-0 group-hover:opacity-100 transition-opacity">→</span>
      </button>
      <button onclick="openChat()" class="elderly-friendly-btn bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-xl hover:shadow-2xl">
        <span aria-hidden="true">🤖</span>
        <span>Asisten Kesehatan AI</span>
        <span class="text-xs bg-white/20 px-2 py-0.5 rounded-full">BARU</span>
      </button>
      <button onclick="openKnowledgeBase()" class="elderly-friendly-btn bg-gradient-to-r from-blue-500 to-indigo-500 text-white shadow-xl hover:shadow-2xl">
        <span aria-hidden="true">📚</span>
        <span>Basis Pengetahuan</span>
      </button>
    </div>
  </section>
  
  <!-- 3D SIMULATION GAME SECTION -->
  <section class="max-w-6xl mx-auto px-4 mb-12" aria-labelledby="simulation-heading">
    <h3 id="simulation-heading" class="text-2xl font-bold text-center mb-8 gradient-text">Simulasi Kesehatan 3D Interaktif</h3>
    <div class="glass rounded-3xl p-6">
      <div class="mb-4 text-center">
        <p class="text-gray-600 dark:text-gray-300 mb-4">
          Latih keseimbangan dan kognitif dengan simulasi 3D yang dirancang khusus untuk lansia. 
          Gunakan tombol kontrol di bawah untuk berinteraksi.
        </p>
        <div class="voice-indicator" id="voiceStatus">
          <span id="voiceIcon">🔇</span>
          <span id="voiceText">Suara tidak aktif</span>
        </div>
      </div>
      
      <div class="game-3d-container" id="gameContainer">
        <div class="game-controls">
          <button class="game-btn" id="moveLeft" aria-label="Gerak ke kiri">⬅️</button>
          <button class="game-btn" id="moveForward" aria-label="Gerak maju">⬆️</button>
          <button class="game-btn" id="moveBackward" aria-label="Gerak mundur">⬇️</button>
          <button class="game-btn" id="moveRight" aria-label="Gerak ke kanan">➡️</button>
        </div>
      </div>
      
      <div class="mt-6 flex flex-wrap justify-center gap-4">
        <button onclick="startBalanceGame()" class="elderly-friendly-btn bg-gradient-to-r from-green-500 to-emerald-500 text-white">
          <span aria-hidden="true">🚶‍♂️</span>
          <span>Latihan Keseimbangan</span>
        </button>
        <button onclick="startMemoryGame()" class="elderly-friendly-btn bg-gradient-to-r from-blue-500 to-indigo-500 text-white">
          <span aria-hidden="true">🧠</span>
          <span>Latihan Memori</span>
        </button>
        <button onclick="startReactionGame()" class="elderly-friendly-btn bg-gradient-to-r from-purple-500 to-pink-500 text-white">
          <span aria-hidden="true">⚡</span>
          <span>Latihan Reaksi</span>
        </button>
      </div>
    </div>
  </section>
  
  <!-- QUICK ACCESS CARDS -->
  <section class="max-w-6xl mx-auto px-4 mb-12" aria-labelledby="quick-access-heading">
    <h3 id="quick-access-heading" class="text-2xl font-bold text-center mb-8 gradient-text">Portal Akses Cepat</h3>
    <div class="grid md:grid-cols-3 gap-6">
      <!-- Enhanced Patient Card -->
      <article class="feature-card glass rounded-2xl p-6 text-center group" onclick="openPatientPortal()" role="button" tabindex="0" aria-label="Portal Pasien">
        <div class="text-4xl mb-4 group-hover:scale-110 transition-transform" aria-hidden="true">👥</div>
        <h4 class="font-bold text-lg mb-2 text-gray-800 dark:text-gray-200">Portal Pasien</h4>
        <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Rekam Medis Elektronik & Pelacakan</p>
        <div class="space-y-1">
          <div class="text-xs text-gray-500 flex items-center justify-center gap-1">
            <span aria-hidden="true">✓</span> Riwayat medis lengkap
          </div>
          <div class="text-xs text-gray-500 flex items-center justify-center gap-1">
            <span aria-hidden="true">✓</span> Pengingat obat otomatis
          </div>
          <div class="text-xs text-gray-500 flex items-center justify-center gap-1">
            <span aria-hidden="true">✓</span> Hasil lab real-time
          </div>
        </div>
        <div class="mt-4 opacity-0 group-hover:opacity-100 transition-opacity">
          <span class="text-teal-600 dark:text-teal-400 text-sm font-medium">Akses Portal →</span>
        </div>
      </article>
      
      <!-- Enhanced Family Card -->
      <article class="feature-card glass rounded-2xl p-6 text-center group" onclick="openFamilyDashboard()" role="button" tabindex="0" aria-label="Dashboard Keluarga">
        <div class="text-4xl mb-4 group-hover:scale-110 transition-transform" aria-hidden="true">👨‍👩‍👧‍👦</div>
        <h4 class="font-bold text-lg mb-2 text-gray-800 dark:text-gray-200">Dashboard Keluarga</h4>
        <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Pemantauan & Koordinasi Perawatan</p>
        <div class="space-y-1">
          <div class="text-xs text-gray-500 flex items-center justify-center gap-1">
            <span aria-hidden="true">✓</span> Pemantauan kesehatan langsung
          </div>
          <div class="text-xs text-gray-500 flex items-center justify-center gap-1">
            <span aria-hidden="true">✓</span> Peringatan darurat
          </div>
          <div class="text-xs text-gray-500 flex items-center justify-center gap-1">
            <span aria-hidden="true">✓</span> Obrolan tim perawatan
          </div>
        </div>
        <div class="mt-4 opacity-0 group-hover:opacity-100 transition-opacity">
          <span class="text-purple-600 dark:text-purple-400 text-sm font-medium">Buka Dashboard →</span>
        </div>
      </article>
      
      <!-- Enhanced Doctor Card -->
      <article class="feature-card glass rounded-2xl p-6 text-center group" onclick="openClinicianHub()" role="button" tabindex="0" aria-label="Pusat Klinisi">
        <div class="text-4xl mb-4 group-hover:scale-110 transition-transform" aria-hidden="true">👨‍⚕️</div>
        <h4 class="font-bold text-lg mb-2 text-gray-800 dark:text-gray-200">Pusat Klinisi</h4>
        <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Keputusan Klinis Berbantuan AI</p>
        <div class="space-y-1">
          <div class="text-xs text-gray-500 flex items-center justify-center gap-1">
            <span aria-hidden="true">✓</span> Dukungan diagnosis AI
          </div>
          <div class="text-xs text-gray-500 flex items-center justify-center gap-1">
            <span aria-hidden="true">✓</span> Protokol berbasis evidence
          </div>
          <div class="text-xs text-gray-500 flex items-center justify-center gap-1">
            <span aria-hidden="true">✓</span> CPOE terintegrasi
          </div>
        </div>
        <div class="mt-4 opacity-0 group-hover:opacity-100 transition-opacity">
          <span class="text-blue-600 dark:text-blue-400 text-sm font-medium">Masuk ke Pusat →</span>
        </div>
      </article>
    </div>
  </section>
  
  <!-- AI INSIGHTS SECTION -->
  <section class="max-w-6xl mx-auto px-4 mb-12" aria-labelledby="insights-heading">
    <div class="glass rounded-3xl p-6">
      <h3 id="insights-heading" class="text-2xl font-bold text-center mb-6 gradient-text">🧠 Wawasan Kesehatan AI</h3>
      
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Predictive Analytics -->
        <div class="bg-gradient-to-br from-purple-100 to-pink-100 dark:from-purple-900 dark:to-pink-900 rounded-xl p-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-2xl" aria-hidden="true">📊</span>
            <h4 class="font-semibold">Analitik Prediktif</h4>
          </div>
          <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">
            AI prediksi risiko jatuh dengan akurasi 94% berdasarkan analisis gait dan riwayat medis.
          </p>
          <button onclick="showPredictiveDemo()" class="text-xs bg-white/50 dark:bg-black/30 px-3 py-1 rounded-full hover:bg-white/70 dark:hover:bg-black/50 transition-colors">
            Lihat Demo →
          </button>
        </div>
        
        <!-- Drug Interaction Checker -->
        <div class="bg-gradient-to-br from-green-100 to-emerald-100 dark:from-green-900 dark:to-emerald-900 rounded-xl p-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-2xl" aria-hidden="true">💊</span>
            <h4 class="font-semibold">Polifarmasi Cerdas</h4>
          </div>
          <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">
            Deteksi interaksi obat real-time dengan database 10.000+ kombinasi geriatri.
          </p>
          <button onclick="openDrugChecker()" class="text-xs bg-white/50 dark:bg-black/30 px-3 py-1 rounded-full hover:bg-white/70 dark:hover:bg-black/50 transition-colors">
            Cek Interaksi →
          </button>
        </div>
        
        <!-- Nutrition AI -->
        <div class="bg-gradient-to-br from-orange-100 to-red-100 dark:from-orange-900 dark:to-red-900 rounded-xl p-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-2xl" aria-hidden="true">🥗</span>
            <h4 class="font-semibold">Nutrisi AI</h4>
          </div>
          <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">
            Perencanaan makanan personal berdasarkan kondisi medis, preferensi, dan target nutrisi.
          </p>
          <button onclick="openNutritionPlanner()" class="text-xs bg-white/50 dark:bg-black/30 px-3 py-1 rounded-full hover:bg-white/70 dark:hover:bg-black/50 transition-colors">
            Rencanakan Makan →
          </button>
        </div>
        
        <!-- Cognitive Assessment -->
        <div class="bg-gradient-to-br from-blue-100 to-indigo-100 dark:from-blue-900 dark:to-indigo-900 rounded-xl p-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-2xl" aria-hidden="true">🧩</span>
            <h4 class="font-semibold">Pelacakan Kognitif</h4>
          </div>
          <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">
            MMSE digital dengan penilaian AI dan analisis tren untuk deteksi dini demensia.
          </p>
          <button onclick="startCognitiveTest()" class="text-xs bg-white/50 dark:bg-black/30 px-3 py-1 rounded-full hover:bg-white/70 dark:hover:bg-black/50 transition-colors">
            Mulai Tes →
          </button>
        </div>
        
        <!-- Exercise AI -->
        <div class="bg-gradient-to-br from-teal-100 to-cyan-100 dark:from-teal-900 dark:to-cyan-900 rounded-xl p-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-2xl" aria-hidden="true">🏃‍♂️</span>
            <h4 class="font-semibold">Pelatih Olahraga AI</h4>
          </div>
          <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">
            Olahraga personal berdasarkan kondisi kardio, muskuloskeletal, dan preferensi.
          </p>
          <button onclick="openExerciseCoach()" class="text-xs bg-white/50 dark:bg-black/30 px-3 py-1 rounded-full hover:bg-white/70 dark:hover:bg-black/50 transition-colors">
            Mulai Program →
          </button>
        </div>
        
        <!-- Sleep Analysis -->
        <div class="bg-gradient-to-br from-indigo-100 to-purple-100 dark:from-indigo-900 dark:to-purple-900 rounded-xl p-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-2xl" aria-hidden="true">😴</span>
            <h4 class="font-semibold">Analisis Tidur</h4>
          </div>
          <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">
            Analisis pola tidur dengan rekomendasi sleep hygiene berbasis ritme sirkadian.
          </p>
          <button onclick="openSleepAnalyzer()" class="text-xs bg-white/50 dark:bg-black/30 px-3 py-1 rounded-full hover:bg-white/70 dark:hover:bg-black/50 transition-colors">
            Analisis Tidur →
          </button>
        </div>
      </div>
    </div>
  </section>
  
  <!-- ENHANCED POLI SECTION -->
  <section class="max-w-6xl mx-auto px-4 mb-12" aria-labelledby="poli-heading">
    <h3 id="poli-heading" class="text-2xl font-bold text-center mb-8 gradient-text">Jaringan Perawatan Terintegrasi</h3>
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
      <article class="feature-card glass rounded-xl p-4 text-center group" onclick="openPoliDetail('cardio')" role="button" tabindex="0">
        <div class="text-2xl mb-2 group-hover:scale-110 transition-transform" aria-hidden="true">❤️</div>
        <h5 class="text-sm font-semibold">Kardio-Geriatri</h5>
        <div class="text-xs text-gray-500 mt-1">Analisis EKG AI</div>
      </article>
      
      <article class="feature-card glass rounded-xl p-4 text-center group" onclick="openPoliDetail('internal')" role="button" tabindex="0">
        <div class="text-2xl mb-2 group-hover:scale-110 transition-transform" aria-hidden="true">🩺</div>
        <h5 class="text-sm font-semibold">Penyakit Dalam</h5>
        <div class="text-xs text-gray-500 mt-1">Perawatan Metabolik</div>
      </article>
      
      <article class="feature-card glass rounded-xl p-4 text-center group" onclick="openPoliDetail('neuro')" role="button" tabindex="0">
        <div class="text-2xl mb-2 group-hover:scale-110 transition-transform" aria-hidden="true">🧠</div>
        <h5 class="text-sm font-semibold">Neuro-Geriatri</h5>
        <div class="text-xs text-gray-500 mt-1">Perawatan Demensia</div>
      </article>
      
      <article class="feature-card glass rounded-xl p-4 text-center group" onclick="openPoliDetail('ortho')" role="button" tabindex="0">
        <div class="text-2xl mb-2 group-hover:scale-110 transition-transform" aria-hidden="true">🦴</div>
        <h5 class="text-sm font-semibold">Orto-Geriatri</h5>
        <div class="text-xs text-gray-500 mt-1">Pencegahan Jatuh</div>
      </article>
      
      <article class="feature-card glass rounded-xl p-4 text-center group" onclick="openPoliDetail('nutrition')" role="button" tabindex="0">
        <div class="text-2xl mb-2 group-hover:scale-110 transition-transform" aria-hidden="true">🥗</div>
        <h5 class="text-sm font-semibold">Gizi Klinis</h5>
        <div class="text-xs text-gray-500 mt-1">Alat MNA-SF</div>
      </article>
      
      <article class="feature-card glass rounded-xl p-4 text-center group" onclick="openPoliDetail('rehab')" role="button" tabindex="0">
        <div class="text-2xl mb-2 group-hover:scale-110 transition-transform" aria-hidden="true">🏃‍♂️</div>
        <h5 class="text-sm font-semibold">Rehabilitasi Medis</h5>
        <div class="text-xs text-gray-500 mt-1">Analisis Gait</div>
      </article>
    </div>
  </section>
  
  <!-- ENHANCED EDUCATION HUB -->
  <section class="max-w-6xl mx-auto px-4 mb-12" aria-labelledby="education-heading">
    <div class="glass rounded-3xl p-6">
      <div class="text-center mb-6">
        <h3 id="education-heading" class="text-2xl font-bold gradient-text mb-2">📚 Pusat Edukasi Berbasis Evidence</h3>
        <p class="text-gray-600 dark:text-gray-300">Konten edukasi berbasis pedoman WHO, IAGG, dan Kemenkes RI</p>
      </div>
      
      <div class="grid md:grid-cols-3 gap-4">
        <!-- Interactive Webinars -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-semibold flex items-center gap-2">
              <span aria-hidden="true">🎥</span> Webinar Langsung
            </h4>
            <span class="text-xs bg-red-500 text-white px-2 py-1 rounded-full animate-pulse">LANGSUNG</span>
          </div>
          <div class="space-y-2">
            <button onclick="joinWebinar('polypharmacy')" class="w-full text-left p-2 rounded bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-sm transition-colors">
              <div class="font-medium">Manajemen Polifarmasi</div>
              <div class="text-xs text-gray-500">Hari ini 14:00 WIB • Dr. Sp.GK</div>
            </button>
            <button onclick="joinWebinar('fall-prevention')" class="w-full text-left p-2 rounded bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-sm transition-colors">
              <div class="font-medium">Asesmen Risiko Jatuh</div>
              <div class="text-xs text-gray-500">Besok 10:00 WIB • Tim Rehab</div>
            </button>
          </div>
        </div>
        
        <!-- AI Learning Modules -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4">
          <h4 class="font-semibold mb-3 flex items-center gap-2">
            <span aria-hidden="true">🤖</span> Jalur Pembelajaran AI
          </h4>
          <div class="space-y-2">
            <div class="p-2 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded">
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium">Sindrom Geriatri</span>
                <span class="text-xs text-gray-500">12 modul</span>
              </div>
              <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mt-2">
                <div class="bg-gradient-to-r from-blue-500 to-indigo-500 h-2 rounded-full" style="width: 75%"></div>
              </div>
            </div>
            <div class="p-2 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded">
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium">Keamanan Obat</span>
                <span class="text-xs text-gray-500">8 modul</span>
              </div>
              <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mt-2">
                <div class="bg-gradient-to-r from-green-500 to-emerald-500 h-2 rounded-full" style="width: 40%"></div>
              </div>
            </div>
          </div>
          <button onclick="openLearningPortal()" class="mt-3 w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-2 rounded-lg text-sm hover:opacity-90 transition-opacity">
            Lanjutkan Belajar →
          </button>
        </div>
        
        <!-- Resource Library -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4">
          <h4 class="font-semibold mb-3 flex items-center gap-2">
            <span aria-hidden="true">📖</span> Perpustakaan Sumber
          </h4>
          <div class="space-y-2 text-sm">
            <button onclick="openResource('who-icope')" class="w-full text-left p-2 rounded bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
              <div class="flex items-center gap-2">
                <span class="text-blue-500">PDF</span>
                <span>Buku Panduan WHO ICOPE</span>
              </div>
            </button>
            <button onclick="openResource('beers-criteria')" class="w-full text-left p-2 rounded bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
              <div class="flex items-center gap-2">
                <span class="text-green-500">XLS</span>
                <span>Kriteria Beers 2023</span>
              </div>
            </button>
            <button onclick="openResource('start-stopp')" class="w-full text-left p-2 rounded bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
              <div class="flex items-center gap-2">
                <span class="text-purple-500">DOC</span>
                <span>START/STOPP v2</span>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>
<!-- FOOTER -->
<footer class="bg-gradient-to-r from-teal-600 to-emerald-600 text-white py-8 mt-12 no-print" role="contentinfo">
  <div class="max-w-6xl mx-auto px-4">
    <div class="grid md:grid-cols-3 gap-6 mb-6">
      <div>
        <h4 class="font-bold mb-2">SIGAP GeriatriCare Pro</h4>
        <p class="text-sm text-gray-200">Platform Kesehatan Geriatri Berbasis AI dengan pendekatan berbasis evidence untuk pelayanan lansia optimal.</p>
      </div>
      <div>
        <h4 class="font-bold mb-2">Tautan Cepat</h4>
        <ul class="text-sm space-y-1">
          <li><a href="#" onclick="openHelp()" class="hover:underline">Pusat Bantuan</a></li>
          <li><a href="#" onclick="openPrivacy()" class="hover:underline">Kebijakan Privasi</a></li>
          <li><a href="#" onclick="openTerms()" class="hover:underline">Syarat Layanan</a></li>
          <li><a href="#" onclick="openAPI()" class="hover:underline">Dokumentasi API</a></li>
        </ul>
      </div>
      <div>
        <h4 class="font-bold mb-2">Kontak & Dukungan</h4>
        <p class="text-sm text-gray-200">
          Dukungan AI 24/7 Tersedia<br>
          Email: support@geriatricare.id<br>
          WhatsApp: +62 812-3456-7890
        </p>
      </div>
    </div>
    <div class="text-center pt-6 border-t border-white/20">
      <p class="text-sm text-gray-200">© 2025 SIGAP GeriatriCare Pro. Ditenagai oleh AI Tingkat Lanjut • Dibuat dengan ❤️ untuk Perawatan Lansia Indonesia</p>
    </div>
  </div>
</footer>
<!-- ENHANCED MODALS -->
<!-- MODAL: ADVANCED SCREENING -->
<div id="screeningModal" class="fixed inset-0 bg-black/50 backdrop-blur-md z-50 hidden items-center justify-center p-4 modal" role="dialog" aria-labelledby="screening-title" aria-modal="true">
  <div class="w-full max-w-4xl h-[90vh] glass rounded-3xl shadow-2xl flex flex-col overflow-hidden">
    <header class="px-6 py-4 bg-gradient-to-r from-emerald-600 to-teal-500 text-white flex justify-between items-center">
      <h3 id="screening-title" class="font-bold text-lg">📋 Sistem Screening Geriatri Tingkat Lanjut</h3>
      <button onclick="closeScreening()" class="text-2xl hover:scale-110 transition-transform" aria-label="Tutup screening">✕</button>
    </header>
    
    <div class="flex-1 p-6 overflow-y-auto">
      <!-- Progress Bar -->
      <div class="mb-6">
        <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-2">
          <span>Kemajuan</span>
          <span id="screeningProgress">0%</span>
        </div>
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
          <div id="progressBar" class="bg-gradient-to-r from-emerald-500 to-teal-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
      </div>
      
      <form id="screeningForm" class="space-y-4">
        <!-- Patient Demographics -->
        <fieldset class="bg-white dark:bg-gray-800 rounded-xl p-4">
          <legend class="font-semibold mb-3 text-teal-700 dark:text-teal-300">👤 Data Demografi</legend>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label for="patientName" class="block text-sm font-medium mb-1">Nama Lengkap <span class="text-red-500">*</span></label>
              <input type="text" id="patientName" name="patientName" placeholder="Masukkan nama lengkap" 
                     class="w-full p-3 rounded-lg border dark:bg-gray-700 focus:border-teal-500 transition-colors" 
                     required aria-required="true">
            </div>
            <div>
              <label for="patientAge" class="block text-sm font-medium mb-1">Usia <span class="text-red-500">*</span></label>
              <input type="number" id="patientAge" name="patientAge" placeholder="60-120" min="60" max="120" 
                     class="w-full p-3 rounded-lg border dark:bg-gray-700 focus:border-teal-500 transition-colors" 
                     required aria-required="true">
            </div>
            <div>
              <label for="patientRM" class="block text-sm font-medium mb-1">No. Rekam Medis</label>
              <input type="text" id="patientRM" name="patientRM" placeholder="RM-XXXXXX" 
                     class="w-full p-3 rounded-lg border dark:bg-gray-700 focus:border-teal-500 transition-colors">
            </div>
            <div>
              <label for="patientGender" class="block text-sm font-medium mb-1">Jenis Kelamin <span class="text-red-500">*</span></label>
              <select id="patientGender" name="patientGender" 
                      class="w-full p-3 rounded-lg border dark:bg-gray-700 focus:border-teal-500 transition-colors" 
                      required aria-required="true">
                <option value="">Pilih jenis kelamin</option>
                <option value="L">Laki-laki</option>
                <option value="P">Perempuan</option>
              </select>
            </div>
          </div>
        </fieldset>
        
        <!-- Vital Signs with Real-time Validation -->
        <fieldset class="bg-white dark:bg-gray-800 rounded-xl p-4">
          <legend class="font-semibold mb-3 text-teal-700 dark:text-teal-300">🩺 Tanda Vital</legend>
          <div class="grid md:grid-cols-3 gap-4">
            <div>
              <label for="bloodPressure" class="block text-sm font-medium mb-1">Tekanan Darah</label>
              <input type="text" id="bloodPressure" name="bloodPressure" placeholder="120/80" 
                     pattern="^\d{2,3}\/\d{2,3}$"
                     class="w-full p-3 rounded-lg border dark:bg-gray-700 focus:border-teal-500 transition-colors">
              <span class="text-xs text-gray-500">Format: 120/80</span>
            </div>
            <div>
              <label for="heartRate" class="block text-sm font-medium mb-1">Nadi (x/menit)</label>
              <input type="number" id="heartRate" name="heartRate" placeholder="60-100" min="40" max="200"
                     class="w-full p-3 rounded-lg border dark:bg-gray-700 focus:border-teal-500 transition-colors">
            </div>
            <div>
              <label for="temperature" class="block text-sm font-medium mb-1">Suhu (°C)</label>
              <input type="number" id="temperature" name="temperature" placeholder="36.5" step="0.1" min="35" max="42"
                     class="w-full p-3 rounded-lg border dark:bg-gray-700 focus:border-teal-500 transition-colors">
            </div>
            <div>
              <label for="respiration" class="block text-sm font-medium mb-1">Respirasi (x/menit)</label>
              <input type="number" id="respiration" name="respiration" placeholder="12-20" min="8" max="40"
                     class="w-full p-3 rounded-lg border dark:bg-gray-700 focus:border-teal-500 transition-colors">
            </div>
            <div>
              <label for="spo2" class="block text-sm font-medium mb-1">SpO2 (%)</label>
              <input type="number" id="spo2" name="spo2" placeholder="95-100" min="70" max="100"
                     class="w-full p-3 rounded-lg border dark:bg-gray-700 focus:border-teal-500 transition-colors">
            </div>
            <div>
              <label for="consciousness" class="block text-sm font-medium mb-1">Kesadaran</label>
              <select id="consciousness" name="consciousness" 
                      class="w-full p-3 rounded-lg border dark:bg-gray-700 focus:border-teal-500 transition-colors">
                <option value="">Pilih status</option>
                <option value="composmentis">Composmentis</option>
                <option value="apatis">Apatis</option>
                <option value="somnolen">Somnolen</option>
                <option value="stupor">Stupor</option>
                <option value="coma">Koma</option>
              </select>
            </div>
          </div>
        </fieldset>
        
        <!-- Enhanced 14-Item Screening with Evidence -->
        <fieldset class="bg-white dark:bg-gray-800 rounded-xl p-4">
          <legend class="font-semibold mb-3 text-teal-700 dark:text-teal-300">🔍 14 Domain Asesmen Geriatri</legend>
          <div class="space-y-4" role="group">
            <!-- Vision -->
            <div class="screening-item p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <label class="block text-sm font-medium mb-1">
                    1. Gangguan Penglihatan
                    <button type="button" onclick="showDomainInfo('vision')" class="ml-2 text-blue-500 hover:text-blue-700" aria-label="Info gangguan penglihatan">
                      <span aria-hidden="true">ⓘ</span>
                    </button>
                  </label>
                  <p class="text-xs text-gray-500">Kesulitan membaca, menonton TV, atau mengenali wajah</p>
                </div>
                <div class="flex items-center space-x-4 ml-4" role="radiogroup" aria-labelledby="vision-label">
                  <label class="flex items-center">
                    <input type="radio" name="vision" value="0" class="mr-2" required>
                    <span class="text-sm">Tidak</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="vision" value="1" class="mr-2">
                    <span class="text-sm">Ya</span>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Hearing -->
            <div class="screening-item p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <label class="block text-sm font-medium mb-1">
                    2. Gangguan Pendengaran
                    <button type="button" onclick="showDomainInfo('hearing')" class="ml-2 text-blue-500 hover:text-blue-700" aria-label="Info gangguan pendengaran">
                      <span aria-hidden="true">ⓘ</span>
                    </button>
                  </label>
                  <p class="text-xs text-gray-500">Kesulitan mendengar percakapan atau memerlukan alat bantu dengar</p>
                </div>
                <div class="flex items-center space-x-4 ml-4" role="radiogroup">
                  <label class="flex items-center">
                    <input type="radio" name="hearing" value="0" class="mr-2" required>
                    <span class="text-sm">Tidak</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="hearing" value="1" class="mr-2">
                    <span class="text-sm">Ya</span>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Balance/Falls -->
            <div class="screening-item p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <label class="block text-sm font-medium mb-1">
                    3. Gangguan Keseimbangan/Riwayat Jatuh
                    <button type="button" onclick="showDomainInfo('balance')" class="ml-2 text-blue-500 hover:text-blue-700" aria-label="Info gangguan keseimbangan">
                      <span aria-hidden="true">ⓘ</span>
                    </button>
                  </label>
                  <p class="text-xs text-gray-500">Jatuh dalam 12 bulan terakhir atau merasa tidak stabil saat berjalan</p>
                </div>
                <div class="flex items-center space-x-4 ml-4" role="radiogroup">
                  <label class="flex items-center">
                    <input type="radio" name="balance" value="0" class="mr-2" required>
                    <span class="text-sm">Tidak</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="balance" value="1" class="mr-2">
                    <span class="text-sm">Ya</span>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Malnutrition -->
            <div class="screening-item p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <label class="block text-sm font-medium mb-1">
                    4. Risiko Malnutrisi
                    <button type="button" onclick="showDomainInfo('nutrition')" class="ml-2 text-blue-500 hover:text-blue-700" aria-label="Info malnutrisi">
                      <span aria-hidden="true">ⓘ</span>
                    </button>
                  </label>
                  <p class="text-xs text-gray-500">Penurunan BB >5% dalam 3 bulan atau IMT <22</p>
                </div>
                <div class="flex items-center space-x-4 ml-4" role="radiogroup">
                  <label class="flex items-center">
                    <input type="radio" name="nutrition" value="0" class="mr-2" required>
                    <span class="text-sm">Tidak</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="nutrition" value="1" class="mr-2">
                    <span class="text-sm">Ya</span>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Urinary Incontinence -->
            <div class="screening-item p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <label class="block text-sm font-medium mb-1">
                    5. Inkontinensia Urin
                    <button type="button" onclick="showDomainInfo('incontinence')" class="ml-2 text-blue-500 hover:text-blue-700" aria-label="Info inkontinensia">
                      <span aria-hidden="true">ⓘ</span>
                    </button>
                  </label>
                  <p class="text-xs text-gray-500">Kesulitan menahan kencing atau ngompol tanpa disadari</p>
                </div>
                <div class="flex items-center space-x-4 ml-4" role="radiogroup">
                  <label class="flex items-center">
                    <input type="radio" name="incontinence" value="0" class="mr-2" required>
                    <span class="text-sm">Tidak</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="incontinence" value="1" class="mr-2">
                    <span class="text-sm">Ya</span>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Depression -->
            <div class="screening-item p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <label class="block text-sm font-medium mb-1">
                    6. Gejala Depresi
                    <button type="button" onclick="showDomainInfo('depression')" class="ml-2 text-blue-500 hover:text-blue-700" aria-label="Info depresi">
                      <span aria-hidden="true">ⓘ</span>
                    </button>
                  </label>
                  <p class="text-xs text-gray-500">Merasa sedih, putus asa, atau kehilangan minat >2 minggu</p>
                </div>
                <div class="flex items-center space-x-4 ml-4" role="radiogroup">
                  <label class="flex items-center">
                    <input type="radio" name="depression" value="0" class="mr-2" required>
                    <span class="text-sm">Tidak</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="depression" value="1" class="mr-2">
                    <span class="text-sm">Ya</span>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Cognitive Impairment -->
            <div class="screening-item p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <label class="block text-sm font-medium mb-1">
                    7. Gangguan Kognitif
                    <button type="button" onclick="showDomainInfo('cognitive')" class="ml-2 text-blue-500 hover:text-blue-700" aria-label="Info kognitif">
                      <span aria-hidden="true">ⓘ</span>
                    </button>
                  </label>
                  <p class="text-xs text-gray-500">Sering lupa, kesulitan mengingat nama atau tanggal</p>
                </div>
                <div class="flex items-center space-x-4 ml-4" role="radiogroup">
                  <label class="flex items-center">
                    <input type="radio" name="cognitive" value="0" class="mr-2" required>
                    <span class="text-sm">Tidak</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="cognitive" value="1" class="mr-2">
                    <span class="text-sm">Ya</span>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Polypharmacy -->
            <div class="screening-item p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <label class="block text-sm font-medium mb-1">
                    8. Polifarmasi
                    <button type="button" onclick="showDomainInfo('polypharmacy')" class="ml-2 text-blue-500 hover:text-blue-700" aria-label="Info polifarmasi">
                      <span aria-hidden="true">ⓘ</span>
                    </button>
                  </label>
                  <p class="text-xs text-gray-500">Mengonsumsi ≥5 jenis obat rutin setiap hari</p>
                </div>
                <div class="flex items-center space-x-4 ml-4" role="radiogroup">
                  <label class="flex items-center">
                    <input type="radio" name="polypharmacy" value="0" class="mr-2" required>
                    <span class="text-sm">Tidak</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="polypharmacy" value="1" class="mr-2">
                    <span class="text-sm">Ya</span>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- ADL Impairment -->
            <div class="screening-item p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <label class="block text-sm font-medium mb-1">
                    9. Gangguan Aktivitas Harian (ADL)
                    <button type="button" onclick="showDomainInfo('adl')" class="ml-2 text-blue-500 hover:text-blue-700" aria-label="Info ADL">
                      <span aria-hidden="true">ⓘ</span>
                    </button>
                  </label>
                  <p class="text-xs text-gray-500">Kesulitan mandi, berpakaian, atau makan sendiri</p>
                </div>
                <div class="flex items-center space-x-4 ml-4" role="radiogroup">
                  <label class="flex items-center">
                    <input type="radio" name="adl" value="0" class="mr-2" required>
                    <span class="text-sm">Tidak</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="adl" value="1" class="mr-2">
                    <span class="text-sm">Ya</span>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Social Isolation -->
            <div class="screening-item p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <label class="block text-sm font-medium mb-1">
                    10. Isolasi Sosial
                    <button type="button" onclick="showDomainInfo('social')" class="ml-2 text-blue-500 hover:text-blue-700" aria-label="Info isolasi sosial">
                      <span aria-hidden="true">ⓘ</span>
                    </button>
                  </label>
                  <p class="text-xs text-gray-500">Jarang berinteraksi atau merasa kesepian</p>
                </div>
                <div class="flex items-center space-x-4 ml-4" role="radiogroup">
                  <label class="flex items-center">
                    <input type="radio" name="social" value="0" class="mr-2" required>
                    <span class="text-sm">Tidak</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="social" value="1" class="mr-2">
                    <span class="text-sm">Ya</span>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Sleep Disorders -->
            <div class="screening-item p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <label class="block text-sm font-medium mb-1">
                    11. Gangguan Tidur
                    <button type="button" onclick="showDomainInfo('sleep')" class="ml-2 text-blue-500 hover:text-blue-700" aria-label="Info gangguan tidur">
                      <span aria-hidden="true">ⓘ</span>
                    </button>
                  </label>
                  <p class="text-xs text-gray-500">Insomnia, sering terbangun, atau tidur <5 jam/hari</p>
                </div>
                <div class="flex items-center space-x-4 ml-4" role="radiogroup">
                  <label class="flex items-center">
                    <input type="radio" name="sleep" value="0" class="mr-2" required>
                    <span class="text-sm">Tidak</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="sleep" value="1" class="mr-2">
                    <span class="text-sm">Ya</span>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Chronic Pain -->
            <div class="screening-item p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <label class="block text-sm font-medium mb-1">
                    12. Nyeri Kronis
                    <button type="button" onclick="showDomainInfo('pain')" class="ml-2 text-blue-500 hover:text-blue-700" aria-label="Info nyeri kronis">
                      <span aria-hidden="true">ⓘ</span>
                    </button>
                  </label>
                  <p class="text-xs text-gray-500">Nyeri persisten >3 bulan yang mengganggu aktivitas</p>
                </div>
                <div class="flex items-center space-x-4 ml-4" role="radiogroup">
                  <label class="flex items-center">
                    <input type="radio" name="pain" value="0" class="mr-2" required>
                    <span class="text-sm">Tidak</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="pain" value="1" class="mr-2">
                    <span class="text-sm">Ya</span>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Hospitalization History -->
            <div class="screening-item p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <label class="block text-sm font-medium mb-1">
                    13. Riwayat Hospitalisasi
                    <button type="button" onclick="showDomainInfo('hospitalization')" class="ml-2 text-blue-500 hover:text-blue-700" aria-label="Info hospitalisasi">
                      <span aria-hidden="true">ⓘ</span>
                    </button>
                  </label>
                  <p class="text-xs text-gray-500">Rawat inap ≥1x dalam 12 bulan terakhir</p>
                </div>
                <div class="flex items-center space-x-4 ml-4" role="radiogroup">
                  <label class="flex items-center">
                    <input type="radio" name="hospitalization" value="0" class="mr-2" required>
                    <span class="text-sm">Tidak</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="hospitalization" value="1" class="mr-2">
                    <span class="text-sm">Ya</span>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Lack of Social Support -->
            <div class="screening-item p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <label class="block text-sm font-medium mb-1">
                    14. Dukungan Sosial Kurang
                    <button type="button" onclick="showDomainInfo('support')" class="ml-2 text-blue-500 hover:text-blue-700" aria-label="Info dukungan sosial">
                      <span aria-hidden="true">ⓘ</span>
                    </button>
                  </label>
                  <p class="text-xs text-gray-500">Tidak ada caregiver atau keluarga yang membantu</p>
                </div>
                <div class="flex items-center space-x-4 ml-4" role="radiogroup">
                  <label class="flex items-center">
                    <input type="radio" name="support" value="0" class="mr-2" required>
                    <span class="text-sm">Tidak</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="support" value="1" class="mr-2">
                    <span class="text-sm">Ya</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </fieldset>
        
        <button type="submit" class="elderly-friendly-btn w-full bg-gradient-to-r from-emerald-600 to-teal-500 text-white shadow-lg">
          📊 Analisis dengan AI & Hasilkan Laporan
        </button>
      </form>
      
      <div id="screeningResult" class="mt-6 hidden"></div>
    </div>
  </div>
</div>

<!-- MODAL: ENHANCED AI CHAT -->
<div id="chatModal" class="fixed inset-0 bg-black/50 backdrop-blur-md z-50 hidden items-center justify-center p-4 modal" role="dialog" aria-labelledby="chat-title" aria-modal="true">
  <div class="w-full max-w-3xl h-[85vh] glass rounded-3xl shadow-2xl flex flex-col overflow-hidden">
    <header class="px-6 py-4 bg-gradient-to-r from-purple-600 to-pink-500 text-white">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <div class="relative">
            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
              <span class="text-xl">🤖</span>
            </div>
            <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
          </div>
          <div>
            <h3 id="chat-title" class="font-semibold">Asisten Kesehatan AI Geriatri</h3>
            <p class="text-xs text-white/80">Ditenagai oleh AI Medis Tingkat Lanjut • Online</p>
          </div>
        </div>
        <button onclick="closeChat()" class="text-xl hover:scale-110 transition-transform" aria-label="Tutup chat">✕</button>
      </div>
    </header>
    
    <div id="chatBody" class="flex-1 p-4 space-y-3 overflow-y-auto bg-gradient-to-b from-gray-50 to-white dark:from-gray-800 dark:to-gray-900" role="log" aria-live="polite" aria-label="Pesan chat">
      <div class="chat-bot text-white p-4 rounded-2xl rounded-bl-md max-w-[80%] text-sm shadow-lg">
        <p class="mb-2">👋 Halo! Saya Asisten GeriatriCare Pro AI dengan akses ke:</p>
        <ul class="space-y-1 text-xs">
          <li>✓ 500+ referensi medis (WHO, IAGG, Kemenkes)</li>
          <li>✓ Protokol geriatri berbasis evidence</li>
          <li>✓ Pemeriksa interaksi obat real-time</li>
          <li>✓ Rekomendasi kesehatan personal</li>
        </ul>
        <p class="mt-2">Silakan tanyakan apa saja tentang kesehatan geriatri!</p>
      </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="px-4 py-2 border-t dark:border-gray-700">
      <div class="flex gap-2 overflow-x-auto pb-2">
        <button onclick="sendQuickMessage('screening')" class="flex-shrink-0 bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-full text-xs hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
          📋 Panduan Screening
        </button>
        <button onclick="sendQuickMessage('medication')" class="flex-shrink-0 bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-full text-xs hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
          💊 Cek Interaksi Obat
        </button>
        <button onclick="sendQuickMessage('fall')" class="flex-shrink-0 bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-full text-xs hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
          🚶 Pencegahan Jatuh
        </button>
        <button onclick="sendQuickMessage('nutrition')" class="flex-shrink-0 bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-full text-xs hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
          🥗 Nutrisi Lansia
        </button>
      </div>
    </div>
    
    <footer class="p-4 bg-white/50 dark:bg-gray-800/50 border-t dark:border-gray-700">
      <div class="flex items-end space-x-2">
        <div class="flex-1">
          <textarea id="chatInput" 
                    placeholder="Tanyakan tentang kesehatan geriatri, obat, nutrisi, atau protokol medis..." 
                    class="w-full p-3 rounded-2xl border dark:bg-gray-700 focus:border-purple-500 transition-colors text-sm resize-none"
                    rows="2"
                    aria-label="Input chat"></textarea>
        </div>
        <div class="flex flex-col gap-2">
          <button onclick="toggleVoiceInput()" class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 p-3 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" aria-label="Input suara">
            🎤
          </button>
          <button onclick="sendMessage()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-3 rounded-xl hover:scale-105 transition-transform shadow-lg" aria-label="Kirim pesan">
            <span aria-hidden="true">📤</span>
          </button>
        </div>
      </div>
    </footer>
  </div>
</div>

<!-- MODAL: KNOWLEDGE BASE -->
<div id="knowledgeModal" class="fixed inset-0 bg-black/50 backdrop-blur-md z-50 hidden items-center justify-center p-4 modal" role="dialog" aria-labelledby="kb-title" aria-modal="true">
  <div class="w-full max-w-5xl h-[90vh] glass rounded-3xl shadow-2xl flex flex-col overflow-hidden">
    <header class="px-6 py-4 bg-gradient-to-r from-blue-600 to-indigo-500 text-white flex justify-between items-center">
      <h3 id="kb-title" class="font-bold text-lg">📚 Basis Pengetahuan Geriatri</h3>
      <button onclick="closeKnowledgeBase()" class="text-2xl hover:scale-110 transition-transform" aria-label="Tutup basis pengetahuan">✕</button>
    </header>
    
    <div class="flex-1 p-6 overflow-y-auto">
      <!-- Search Bar -->
      <div class="mb-6">
        <input type="text" id="kbSearch" placeholder="Cari pedoman, protokol, obat-obatan..." 
               class="w-full p-3 rounded-xl border dark:bg-gray-700 focus:border-blue-500 transition-colors"
               onkeyup="searchKnowledgeBase(this.value)">
      </div>
      
      <!-- Categories -->
      <div class="grid md:grid-cols-3 gap-4">
        <!-- Clinical Guidelines -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4">
          <h4 class="font-semibold mb-3 text-blue-600 dark:text-blue-400">📋 Pedoman Klinis</h4>
          <ul class="space-y-2 text-sm">
            <li><button onclick="showKBContent('who-icope')" class="text-left hover:text-blue-500 transition-colors">Buku Panduan WHO ICOPE 2023</button></li>
            <li><button onclick="showKBContent('nice-dementia')" class="text-left hover:text-blue-500 transition-colors">Pedoman Dementia NICE</button></li>
            <li><button onclick="showKBContent('ags-beers')" class="text-left hover:text-blue-500 transition-colors">Kriteria Beers AGS 2023</button></li>
            <li><button onclick="showKBContent('start-stopp')" class="text-left hover:text-blue-500 transition-colors">START/STOPP v2</button></li>
          </ul>
        </div>
        
        <!-- Assessment Tools -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4">
          <h4 class="font-semibold mb-3 text-green-600 dark:text-green-400">🔍 Alat Asesmen</h4>
          <ul class="space-y-2 text-sm">
            <li><button onclick="showKBContent('mmse')" class="text-left hover:text-green-500 transition-colors">Kalkulator MMSE</button></li>
            <li><button onclick="showKBContent('mna-sf')" class="text-left hover:text-green-500 transition-colors">Nutrisi MNA-SF</button></li>
            <li><button onclick="showKBContent('morse-fall')" class="text-left hover:text-green-500 transition-colors">Skala Morse Fall</button></li>
            <li><button onclick="showKBContent('gds-15')" class="text-left hover:text-green-500 transition-colors">Depresi GDS-15</button></li>
          </ul>
        </div>
        
        <!-- Medication Database -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4">
          <h4 class="font-semibold mb-3 text-purple-600 dark:text-purple-400">💊 Keamanan Obat</h4>
          <ul class="space-y-2 text-sm">
            <li><button onclick="showKBContent('drug-interactions')" class="text-left hover:text-purple-500 transition-colors">Pemeriksa Interaksi Obat</button></li>
            <li><button onclick="showKBContent('renal-dosing')" class="text-left hover:text-purple-500 transition-colors">Panduan Dosis Ginjal</button></li>
            <li><button onclick="showKBContent('pim-list')" class="text-left hover:text-purple-500 transition-colors">Daftar PIM Indonesia</button></li>
            <li><button onclick="showKBContent('deprescribing')" class="text-left hover:text-purple-500 transition-colors">Protokol Deprescribing</button></li>
          </ul>
        </div>
      </div>
      
      <div id="kbContent" class="mt-6"></div>
    </div>
  </div>
</div>

<!-- Enhanced JavaScript -->
<script>
/* ===== GLOBAL CONFIGURATION ===== */
const CONFIG = {
  API_ENDPOINT: 'https://free-ai-proxy.vercel.app/api/qwen',
  KNOWLEDGE_BASE_URL: 'https://raw.githubusercontent.com/geriatricare/knowledge-base/main/',
  VERSION: '6.5.0',
  BUILD_DATE: '2025-01-22',
  FEATURES: {
    AI_CHAT: true,
    VOICE_INPUT: true,
    OFFLINE_MODE: true,
    ANALYTICS: true,
    TELEMETRY: false,
    THREE_D_GAME: true
  }
};

/* ===== STATE MANAGEMENT ===== */
const AppState = {
  fontSize: parseInt(localStorage.getItem('fontSize') || '18'),
  theme: localStorage.getItem('theme') || 'light',
  speechEnabled: localStorage.getItem('speechEnabled') !== 'false',
  language: 'id-ID',
  user: null,
  chatHistory: [],
  screeningData: {},
  knowledgeCache: new Map(),
  game3D: {
    scene: null,
    camera: null,
    renderer: null,
    character: null,
    gameType: null,
    score: 0,
    isPlaying: false
  }
};

/* ===== KNOWLEDGE BASE ===== */
const KNOWLEDGE_DB = [
  {
    id: 'hypertension-elderly',
    category: 'cardiovascular',
    title: 'Hipertensi pada Lansia',
    content: 'Target tekanan darah untuk lansia ≥65 tahun adalah <140/90 mmHg (WHO 2023, Hypertension in adults guidelines §3.2). Untuk lansia >80 tahun atau frail, target <150/90 mmHg dapat dipertimbangkan.',
    references: [
      { source: 'WHO 2023', url: 'https://www.who.int/publications/i/item/9789240081062' },
      { source: 'ESC/ESH 2023', url: 'https://academic.oup.com/eurheartj/article/44/38/3627' }
    ],
    tags: ['hipertensi', 'tekanan darah', 'kardiovaskular']
  },
  {
    id: 'polypharmacy-management',
    category: 'medication',
    title: 'Manajemen Polifarmasi',
    content: 'Polifarmasi (≥5 obat) meningkatkan risiko adverse drug events 88% (Masnoon et al., 2017). Gunakan START/STOPP criteria v2 untuk optimasi terapi. Review obat setiap 3-6 bulan.',
    references: [
      { source: 'START/STOPP v2', url: 'https://pubmed.ncbi.nlm.nih.gov/25324330/' },
      { source: 'AGS Beers 2023', url: 'https://www.americangeriatrics.org/programs/beers-criteria' }
    ],
    tags: ['polifarmasi', 'interaksi obat', 'medication safety']
  },
  {
    id: 'fall-prevention',
    category: 'mobility',
    title: 'Pencegahan Jatuh',
    content: 'Risiko jatuh meningkat 2x lipat setiap dekade setelah usia 65. Intervensi multifaktorial menurunkan risiko 24% (Cochrane Review 2019): strength training, balance exercise, home safety, medication review, vision correction.',
    references: [
      { source: 'NICE CG161', url: 'https://www.nice.org.uk/guidance/cg161' },
      { source: 'CDC STEADI', url: 'https://www.cdc.gov/steadi/' }
    ],
    tags: ['jatuh', 'keseimbangan', 'mobilitas', 'fall risk']
  },
  {
    id: 'dementia-screening',
    category: 'cognitive',
    title: 'Skrining Demensia',
    content: 'MMSE <24 atau MoCA <26 indikasi gangguan kognitif. Prevalensi demensia: 5-8% usia 65+, doubles every 5 years. Early detection improves QoL.',
    references: [
      { source: 'WHO Dementia', url: 'https://www.who.int/news-room/fact-sheets/detail/dementia' },
      { source: 'Alzheimer Assoc', url: 'https://www.alz.org/professionals/health-systems-medical-professionals' }
    ],
    tags: ['demensia', 'kognitif', 'MMSE', 'MoCA', 'alzheimer']
  },
  {
    id: 'malnutrition-assessment',
    category: 'nutrition',
    title: 'Asesmen Malnutrisi',
    content: 'Prevalensi malnutrisi 5-10% community dwelling, 20-40% hospitalized elderly. MNA-SF <12 = at risk. Kriteria: BMI <22, weight loss >5% in 3 months, reduced intake.',
    references: [
      { source: 'ESPEN Guidelines', url: 'https://www.espen.org/guidelines-home' },
      { source: 'MNA Tool', url: 'https://www.mna-elderly.com/' }
    ],
    tags: ['malnutrisi', 'gizi', 'MNA', 'nutrition']
  },
  {
    id: 'depression-elderly',
    category: 'mental-health',
    title: 'Depresi pada Lansia',
    content: 'Prevalensi depresi 10-15% lansia komunitas, 25% dengan penyakit kronis. GDS-15 ≥5 = screening positif. First-line: SSRI (start low, go slow). Psychotherapy equally effective.',
    references: [
      { source: 'APA Guidelines', url: 'https://www.apa.org/depression-guideline' },
      { source: 'CANMAT 2023', url: 'https://www.canmat.org/guidelines/' }
    ],
    tags: ['depresi', 'mental health', 'GDS', 'antidepresan']
  },
  {
    id: 'sarcopenia-diagnosis',
    category: 'musculoskeletal',
    title: 'Diagnosis Sarkopenia',
    content: 'Kriteria EWGSOP2: Low muscle strength (handgrip <27kg ♂, <16kg ♀) + low muscle mass (DEXA/BIA). Prevalensi 10-30% ≥65 tahun. Intervensi: resistance exercise + protein 1.2-1.5g/kg/day.',
    references: [
      { source: 'EWGSOP2 2019', url: 'https://pubmed.ncbi.nlm.nih.gov/30312372/' },
      { source: 'AWGS 2019', url: 'https://pubmed.ncbi.nlm.nih.gov/31942155/' }
    ],
    tags: ['sarkopenia', 'muscle mass', 'frailty', 'protein']
  },
  {
    id: 'urinary-incontinence',
    category: 'genitourinary',
    title: 'Inkontinensia Urin',
    content: 'Prevalensi 15-35% lansia. Tipe: stress (batuk/bersin), urge (overactive bladder), mixed, overflow. First-line: behavioral (bladder training, pelvic floor exercise). Pharmacotherapy: antimuscarinics (caution: cognitive SE).',
    references: [
      { source: 'ICS Guidelines', url: 'https://www.ics.org/standards' },
      { source: 'AUA/SUFU', url: 'https://www.auanet.org/guidelines' }
    ],
    tags: ['inkontinensia', 'bladder', 'pelvic floor']
  },
  {
    id: 'sleep-disorders',
    category: 'sleep',
    title: 'Gangguan Tidur Lansia',
    content: 'Prevalensi insomnia 30-48%. Sleep architecture changes: ↓ slow wave sleep, ↑ awakening. Sleep hygiene first-line. Avoid benzodiazepines (fall risk). Consider melatonin 2-5mg.',
    references: [
      { source: 'AASM Guidelines', url: 'https://aasm.org/clinical-resources/' },
      { source: 'Sleep Foundation', url: 'https://www.sleepfoundation.org/aging-and-sleep' }
    ],
    tags: ['insomnia', 'sleep', 'melatonin', 'tidur']
  },
  {
    id: 'vaccination-elderly',
    category: 'preventive',
    title: 'Vaksinasi Lansia',
    content: 'Rekomendasi: Influenza annually, Pneumococcal (PCV13 + PPSV23), Herpes Zoster ≥50y, COVID-19 boosters. Tdap every 10y. Immunosenescence reduces efficacy but benefits remain significant.',
    references: [
      { source: 'CDC ACIP', url: 'https://www.cdc.gov/vaccines/schedules/hcp/imz/adult.html' },
      { source: 'WHO Immunization', url: 'https://www.who.int/teams/immunization-vaccines-and-biologicals' }
    ],
    tags: ['vaksinasi', 'imunisasi', 'influenza', 'pneumonia']
  }
];

/* ===== ENHANCED AI SYSTEM ===== */
class GeriatricAI {
  constructor() {
    this.context = [];
    this.maxContext = 10;
    this.model = 'qwen-32b';
    this.temperature = 0.7;
  }
  
  async generateResponse(prompt, options = {}) {
    try {
      // Search knowledge base first
      const relevantKnowledge = this.searchKnowledge(prompt);
      
      // Build enhanced prompt with context
      const enhancedPrompt = this.buildEnhancedPrompt(prompt, relevantKnowledge, options);
      
      // Call AI API
      const response = await fetch(CONFIG.API_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          prompt: enhancedPrompt,
          temperature: this.temperature,
          max_tokens: 1000,
          system: "You are an expert geriatrician AI assistant with access to WHO, IAGG, and evidence-based guidelines. Always cite credible sources."
        })
      });
      
      if (!response.ok) throw new Error('AI service unavailable');
      
      const data = await response.json();
      const aiResponse = data.reply || data.response || data.text || 'Maaf, terjadi kesalahan.';
      
      // Add to context
      this.addToContext(prompt, aiResponse);
      
      return this.formatResponse(aiResponse, relevantKnowledge);
    } catch (error) {
      console.error('AI Error:', error);
      return this.getFallbackResponse(prompt);
    }
  }
  
  searchKnowledge(query) {
    const keywords = query.toLowerCase().split(' ');
    const matches = [];
    
    for (const item of KNOWLEDGE_DB) {
      let score = 0;
      
      // Check title match
      if (item.title.toLowerCase().includes(query.toLowerCase())) score += 5;
      
      // Check tag matches
      for (const keyword of keywords) {
        if (item.tags.some(tag => tag.includes(keyword))) score += 2;
        if (item.content.toLowerCase().includes(keyword)) score += 1;
      }
      
      if (score > 0) {
        matches.push({ ...item, score });
      }
    }
    
    // Sort by relevance and return top 3
    return matches.sort((a, b) => b.score - a.score).slice(0, 3);
  }
  
  buildEnhancedPrompt(userPrompt, knowledge, options) {
    let prompt = `User Question: ${userPrompt}\n\n`;
    
    if (knowledge.length > 0) {
      prompt += "Relevant Medical Knowledge:\n";
      knowledge.forEach(item => {
        prompt += `- ${item.title}: ${item.content}\n`;
        if (item.references.length > 0) {
          prompt += `  References: ${item.references.map(r => r.source).join(', ')}\n`;
        }
      });
      prompt += "\n";
    }
    
    if (this.context.length > 0) {
      prompt += "Previous Context:\n";
      const recentContext = this.context.slice(-3);
      recentContext.forEach(ctx => {
        prompt += `User: ${ctx.user}\nAssistant: ${ctx.assistant.substring(0, 100)}...\n`;
      });
      prompt += "\n";
    }
    
    prompt += `Please provide a comprehensive, evidence-based answer specific to geriatric care. 
Include relevant guidelines, cite sources when available, and consider the unique aspects of elderly patients. 
Answer in Bahasa Indonesia unless asked otherwise.`;
    
    return prompt;
  }
  
  formatResponse(response, knowledge) {
    let formatted = response;
    
    // Add knowledge cards if relevant
    if (knowledge.length > 0) {
      formatted += '\n\n📚 **Referensi Terkait:**\n';
      knowledge.forEach(item => {
        formatted += `\n**${item.title}**\n`;
        formatted += `${item.content.substring(0, 200)}...\n`;
        if (item.references.length > 0) {
          formatted += `🔗 Sumber: `;
          item.references.forEach((ref, idx) => {
            formatted += `[${ref.source}](${ref.url})`;
            if (idx < item.references.length - 1) formatted += ', ';
          });
          formatted += '\n';
        }
      });
    }
    
    return formatted;
  }
  
  addToContext(userPrompt, assistantResponse) {
    this.context.push({
      user: userPrompt,
      assistant: assistantResponse,
      timestamp: Date.now()
    });
    
    // Keep context size manageable
    if (this.context.length > this.maxContext) {
      this.context = this.context.slice(-this.maxContext);
    }
  }
  
  getFallbackResponse(prompt) {
    const lowerPrompt = prompt.toLowerCase();
    
    // Check for specific topics
    if (lowerPrompt.includes('hipertensi') || lowerPrompt.includes('tekanan darah')) {
      const knowledge = KNOWLEDGE_DB.find(k => k.id === 'hypertension-elderly');
      return this.formatResponse(knowledge.content, [knowledge]);
    }
    
    if (lowerPrompt.includes('jatuh') || lowerPrompt.includes('fall')) {
      const knowledge = KNOWLEDGE_DB.find(k => k.id === 'fall-prevention');
      return this.formatResponse(knowledge.content, [knowledge]);
    }
    
    if (lowerPrompt.includes('obat') || lowerPrompt.includes('polifarmasi')) {
      const knowledge = KNOWLEDGE_DB.find(k => k.id === 'polypharmacy-management');
      return this.formatResponse(knowledge.content, [knowledge]);
    }
    
    if (lowerPrompt.includes('demensia') || lowerPrompt.includes('kognitif')) {
      const knowledge = KNOWLEDGE_DB.find(k => k.id === 'dementia-screening');
      return this.formatResponse(knowledge.content, [knowledge]);
    }
    
    // Generic response
    return `Maaf, saya sedang mengalami kendala teknis. Untuk informasi kesehatan geriatri yang akurat, saya sarankan:
1. Konsultasi dengan dokter spesialis geriatri
2. Rujuk ke panduan WHO ICOPE atau Kemenkes RI
3. Gunakan fitur screening geriatri untuk evaluasi awal
Apakah ada hal spesifik yang ingin Anda tanyakan tentang kesehatan lansia?`;
  }
}

// Initialize AI
const geriatricAI = new GeriatricAI();

/* ===== 3D GAME SYSTEM ===== */
class Game3D {
  constructor(containerId) {
    this.container = document.getElementById(containerId);
    this.scene = null;
    this.camera = null;
    this.renderer = null;
    this.character = null;
    this.gameType = null;
    this.score = 0;
    this.isPlaying = false;
    this.objects = [];
    this.init();
  }
  
  init() {
    // Create scene
    this.scene = new THREE.Scene();
    this.scene.background = new THREE.Color(0x0f172a);
    
    // Create camera
    this.camera = new THREE.PerspectiveCamera(
      75,
      this.container.clientWidth / this.container.clientHeight,
      0.1,
      1000
    );
    this.camera.position.set(0, 5, 10);
    this.camera.lookAt(0, 0, 0);
    
    // Create renderer
    this.renderer = new THREE.WebGLRenderer({ antialias: true });
    this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);
    this.renderer.shadowMap.enabled = true;
    this.container.appendChild(this.renderer.domElement);
    
    // Add lights
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    this.scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(10, 20, 15);
    directionalLight.castShadow = true;
    this.scene.add(directionalLight);
    
    // Add ground
    const groundGeometry = new THREE.PlaneGeometry(20, 20);
    const groundMaterial = new THREE.MeshStandardMaterial({ 
      color: 0x1e293b,
      roughness: 0.8,
      metalness: 0.2
    });
    const ground = new THREE.Mesh(groundGeometry, groundMaterial);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    this.scene.add(ground);
    
    // Add grid helper
    const gridHelper = new THREE.GridHelper(20, 20, 0x475569, 0x334155);
    this.scene.add(gridHelper);
    
    // Create character
    this.createCharacter();
    
    // Add controls
    this.setupControls();
    
    // Handle window resize
    window.addEventListener('resize', () => this.onWindowResize());
    
    // Start animation
    this.animate();
  }
  
  createCharacter() {
    // Create a simple character using basic shapes
    const characterGroup = new THREE.Group();
    
    // Body
    const bodyGeometry = new THREE.CapsuleGeometry(0.5, 1, 4, 8);
    const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0x3b82f6 });
    const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
    body.position.y = 1;
    body.castShadow = true;
    characterGroup.add(body);
    
    // Head
    const headGeometry = new THREE.SphereGeometry(0.4, 16, 16);
    const headMaterial = new THREE.MeshStandardMaterial({ color: 0xfbbf24 });
    const head = new THREE.Mesh(headGeometry, headMaterial);
    head.position.y = 2;
    head.castShadow = true;
    characterGroup.add(head);
    
    // Eyes
    const eyeGeometry = new THREE.SphereGeometry(0.1, 8, 8);
    const eyeMaterial = new THREE.MeshStandardMaterial({ color: 0x000000 });
    
    const leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
    leftEye.position.set(-0.15, 2.1, 0.35);
    characterGroup.add(leftEye);
    
    const rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
    rightEye.position.set(0.15, 2.1, 0.35);
    characterGroup.add(rightEye);
    
    this.character = characterGroup;
    this.scene.add(this.character);
  }
  
  setupControls() {
    // Set up button controls
    document.getElementById('moveLeft').addEventListener('click', () => this.moveCharacter('left'));
    document.getElementById('moveRight').addEventListener('click', () => this.moveCharacter('right'));
    document.getElementById('moveForward').addEventListener('click', () => this.moveCharacter('forward'));
    document.getElementById('moveBackward').addEventListener('click', () => this.moveCharacter('backward'));
    
    // Keyboard controls
    document.addEventListener('keydown', (event) => {
      if (!this.isPlaying) return;
      
      switch(event.key) {
        case 'ArrowLeft':
        case 'a':
        case 'A':
          this.moveCharacter('left');
          break;
        case 'ArrowRight':
        case 'd':
        case 'D':
          this.moveCharacter('right');
          break;
        case 'ArrowUp':
        case 'w':
        case 'W':
          this.moveCharacter('forward');
          break;
        case 'ArrowDown':
        case 's':
        case 'S':
          this.moveCharacter('backward');
          break;
      }
    });
  }
  
  moveCharacter(direction) {
    if (!this.character) return;
    
    const moveDistance = 0.5;
    
    switch(direction) {
      case 'left':
        this.character.position.x -= moveDistance;
        this.character.rotation.y = Math.PI / 2;
        break;
      case 'right':
        this.character.position.x += moveDistance;
        this.character.rotation.y = -Math.PI / 2;
        break;
      case 'forward':
        this.character.position.z -= moveDistance;
        this.character.rotation.y = 0;
        break;
      case 'backward':
        this.character.position.z += moveDistance;
        this.character.rotation.y = Math.PI;
        break;
    }
    
    // Keep character within bounds
    this.character.position.x = Math.max(-9, Math.min(9, this.character.position.x));
    this.character.position.z = Math.max(-9, Math.min(9, this.character.position.z));
    
    // Simple bounce animation
    const originalY = this.character.position.y;
    this.character.position.y = originalY + 0.2;
    setTimeout(() => {
      this.character.position.y = originalY;
    }, 200);
    
    // Check for game-specific interactions
    if (this.isPlaying && this.gameType) {
      this.checkGameInteraction();
    }
  }
  
  startBalanceGame() {
    this.gameType = 'balance';
    this.isPlaying = true;
    this.score = 0;
    
    // Clear previous objects
    this.objects.forEach(obj => this.scene.remove(obj));
    this.objects = [];
    
    // Create balance beam
    const beamGeometry = new THREE.BoxGeometry(10, 0.2, 0.5);
    const beamMaterial = new THREE.MeshStandardMaterial({ color: 0x8b5cf6 });
    const beam = new THREE.Mesh(beamGeometry, beamMaterial);
    beam.position.y = 0.6;
    beam.castShadow = true;
    this.scene.add(beam);
    this.objects.push(beam);
    
    // Position character on beam
    this.character.position.set(0, 1, 0);
    
    // Create target zones
    for (let i = 0; i < 5; i++) {
      const zoneGeometry = new THREE.CylinderGeometry(0.8, 0.8, 0.1, 16);
      const zoneMaterial = new THREE.MeshStandardMaterial({ 
        color: i === 0 ? 0x10b981 : 0x64748b,
        transparent: true,
        opacity: 0.7
      });
      const zone = new THREE.Mesh(zoneGeometry, zoneMaterial);
      zone.position.set(
        (Math.random() - 0.5) * 8,
        0.65,
        (Math.random() - 0.5) * 0.3
      );
      this.scene.add(zone);
      this.objects.push(zone);
    }
    
    // Announce game start
    announceToScreenReader('Permainan keseimbangan dimulai. Gunakan tombol panah atau WASD untuk bergerak.');
    if (AppState.speechEnabled) {
      speakText('Permainan keseimbangan dimulai. Gunakan tombol panah atau WASD untuk bergerak.');
    }
  }
  
  startMemoryGame() {
    this.gameType = 'memory';
    this.isPlaying = true;
    this.score = 0;
    
    // Clear previous objects
    this.objects.forEach(obj => this.scene.remove(obj));
    this.objects = [];
    
    // Position character at center
    this.character.position.set(0, 1, 0);
    
    // Create memory objects
    const colors = [0xef4444, 0x3b82f6, 0x10b981, 0xf59e0b, 0x8b5cf6];
    const positions = [
      { x: -3, z: -3 },
      { x: 3, z: -3 },
      { x: -3, z: 3 },
      { x: 3, z: 3 },
      { x: 0, z: 0 }
    ];
    
    // Show sequence
    this.memorySequence = [];
    for (let i = 0; i < 5; i++) {
      const objGeometry = new THREE.BoxGeometry(1, 1, 1);
      const objMaterial = new THREE.MeshStandardMaterial({ 
        color: colors[i],
        emissive: colors[i],
        emissiveIntensity: 0.2
      });
      const obj = new THREE.Mesh(objGeometry, objMaterial);
      obj.position.set(positions[i].x, 0.5, positions[i].z);
      obj.castShadow = true;
      obj.userData = { colorIndex: i, id: i };
      this.scene.add(obj);
      this.objects.push(obj);
      this.memorySequence.push(i);
    }
    
    // Announce game start
    announceToScreenReader('Permainan memori dimulai. Perhatikan urutan objek yang menyala.');
    if (AppState.speechEnabled) {
      speakText('Permainan memori dimulai. Perhatikan urutan objek yang menyala.');
    }
    
    // Show sequence
    this.showMemorySequence();
  }
  
  showMemorySequence() {
    let index = 0;
    
    const showNext = () => {
      if (index < this.memorySequence.length) {
        // Light up current object
        const obj = this.objects[this.memorySequence[index]];
        obj.material.emissiveIntensity = 0.8;
        
        // Announce color
        const colorNames = ['merah', 'biru', 'hijau', 'kuning', 'ungu'];
        if (AppState.speechEnabled) {
          speakText(colorNames[obj.userData.colorIndex]);
        }
        
        setTimeout(() => {
          obj.material.emissiveIntensity = 0.2;
          index++;
          setTimeout(showNext, 500);
        }, 1000);
      } else {
        // Sequence complete, now player's turn
        announceToScreenReader('Sekarang giliran Anda. Sentuh objek dalam urutan yang sama.');
        if (AppState.speechEnabled) {
          speakText('Sekarang giliran Anda. Sentuh objek dalam urutan yang sama.');
        }
        this.memoryPlayerIndex = 0;
      }
    };
    
    showNext();
  }
  
  startReactionGame() {
    this.gameType = 'reaction';
    this.isPlaying = true;
    this.score = 0;
    
    // Clear previous objects
    this.objects.forEach(obj => this.scene.remove(obj));
    this.objects = [];
    
    // Position character at center
    this.character.position.set(0, 1, 0);
    
    // Announce game start
    announceToScreenReader('Permainan reaksi dimulai. Sentuh objek yang muncul secepat mungkin.');
    if (AppState.speechEnabled) {
      speakText('Permainan reaksi dimulai. Sentuh objek yang muncul secepat mungkin.');
    }
    
    // Start spawning targets
    this.spawnReactionTarget();
  }
  
  spawnReactionTarget() {
    if (!this.isPlaying || this.gameType !== 'reaction') return;
    
    // Create target
    const targetGeometry = new THREE.SphereGeometry(0.5, 16, 16);
    const targetMaterial = new THREE.MeshStandardMaterial({ 
      color: 0xef4444,
      emissive: 0xef4444,
      emissiveIntensity: 0.3
    });
    const target = new THREE.Mesh(targetGeometry, targetMaterial);
    
    // Random position
    target.position.set(
      (Math.random() - 0.5) * 16,
      0.5,
      (Math.random() - 0.5) * 16
    );
    target.castShadow = true;
    
    this.scene.add(target);
    this.objects.push(target);
    
    // Remove target after delay
    setTimeout(() => {
      this.scene.remove(target);
      const index = this.objects.indexOf(target);
      if (index > -1) {
        this.objects.splice(index, 1);
      }
      
      // Spawn next target
      setTimeout(() => this.spawnReactionTarget(), 1000);
    }, 2000);
  }
  
  checkGameInteraction() {
    if (!this.isPlaying || !this.gameType) return;
    
    // Get character position
    const charPos = this.character.position;
    
    if (this.gameType === 'balance') {
      // Check if character is on balance beam
      if (Math.abs(charPos.x) > 4.5 || Math.abs(charPos.z) > 0.2) {
        // Character fell
        this.isPlaying = false;
        announceToScreenReader('Anda terjatuh! Skor akhir: ' + this.score);
        if (AppState.speechEnabled) {
          speakText('Anda terjatuh! Skor akhir: ' + this.score);
        }
        return;
      }
      
      // Check if character reached target zones
      this.objects.forEach(obj => {
        if (obj.geometry.type === 'CylinderGeometry') {
          const distance = Math.sqrt(
            Math.pow(charPos.x - obj.position.x, 2) + 
            Math.pow(charPos.z - obj.position.z, 2)
          );
          
          if (distance < 0.8 && obj.material.color.getHex() === 0x10b981) {
            // Reached target
            this.score += 10;
            obj.material.color.setHex(0x64748b);
            announceToScreenReader('Bagus! Skor: ' + this.score);
            if (AppState.speechEnabled) {
              speakText('Bagus! Skor: ' + this.score);
            }
          }
        }
      });
    } else if (this.gameType === 'memory') {
      // Check if character is near an object
      this.objects.forEach(obj => {
        if (obj.geometry.type === 'BoxGeometry') {
          const distance = Math.sqrt(
            Math.pow(charPos.x - obj.position.x, 2) + 
            Math.pow(charPos.z - obj.position.z, 2)
          );
          
          if (distance < 1.5) {
            // Check if this is the correct object in sequence
            if (obj.userData.id === this.memorySequence[this.memoryPlayerIndex]) {
              // Correct object
              this.score += 10;
              this.memoryPlayerIndex++;
              
              // Light up object
              obj.material.emissiveIntensity = 0.8;
              
              announceToScreenReader('Benar! Skor: ' + this.score);
              if (AppState.speechEnabled) {
                speakText('Benar! Skor: ' + this.score);
              }
              
              // Check if sequence complete
              if (this.memoryPlayerIndex >= this.memorySequence.length) {
                this.isPlaying = false;
                announceToScreenReader('Urutan lengkap! Skor akhir: ' + this.score);
                if (AppState.speechEnabled) {
                  speakText('Urutan lengkap! Skor akhir: ' + this.score);
                }
              }
            } else {
              // Wrong object
              this.isPlaying = false;
              announceToScreenReader('Salah urutan! Skor akhir: ' + this.score);
              if (AppState.speechEnabled) {
                speakText('Salah urutan! Skor akhir: ' + this.score);
              }
            }
          }
        }
      });
    } else if (this.gameType === 'reaction') {
      // Check if character is near a target
      this.objects.forEach(obj => {
        if (obj.geometry.type === 'SphereGeometry') {
          const distance = Math.sqrt(
            Math.pow(charPos.x - obj.position.x, 2) + 
            Math.pow(charPos.z - obj.position.z, 2)
          );
          
          if (distance < 1.5) {
            // Hit target
            this.score += 10;
            this.scene.remove(obj);
            const index = this.objects.indexOf(obj);
            if (index > -1) {
              this.objects.splice(index, 1);
            }
            
            announceToScreenReader('Target terkena! Skor: ' + this.score);
            if (AppState.speechEnabled) {
              speakText('Target terkena! Skor: ' + this.score);
            }
          }
        }
      });
    }
  }
  
  onWindowResize() {
    this.camera.aspect = this.container.clientWidth / this.container.clientHeight;
    this.camera.updateProjectionMatrix();
    this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);
  }
  
  animate() {
    requestAnimationFrame(() => this.animate());
    
    // Rotate character slightly when idle
    if (this.character && !this.isPlaying) {
      this.character.rotation.y += 0.005;
    }
    
    this.renderer.render(this.scene, this.camera);
  }
}

/* ===== THEME & UI FUNCTIONS ===== */
function initializeTheme() {
  const html = document.documentElement;
  if (AppState.theme === 'dark') {
    html.classList.add('dark');
    document.getElementById('themeToggle').innerHTML = '☀️';
  }
  document.body.style.fontSize = AppState.fontSize + 'px';
  updateFontSizeButtons();
}

function toggleTheme() {
  const html = document.documentElement;
  const themeBtn = document.getElementById('themeToggle');
  
  html.classList.toggle('dark');
  const isDark = html.classList.contains('dark');
  
  themeBtn.innerHTML = isDark ? '☀️' : '🌙';
  AppState.theme = isDark ? 'dark' : 'light';
  localStorage.setItem('theme', AppState.theme);
  
  // Announce theme change
  announceToScreenReader(`Tema diubah ke mode ${isDark ? 'gelap' : 'terang'}`);
}

function increaseFontSize() {
  if (AppState.fontSize < 24) {
    AppState.fontSize += 2;
    document.body.style.fontSize = AppState.fontSize + 'px';
    localStorage.setItem('fontSize', AppState.fontSize);
    updateFontSizeButtons();
    announceToScreenReader('Ukuran font diperbesar');
  }
}

function decreaseFontSize() {
  if (AppState.fontSize > 14) {
    AppState.fontSize -= 2;
    document.body.style.fontSize = AppState.fontSize + 'px';
    localStorage.setItem('fontSize', AppState.fontSize);
    updateFontSizeButtons();
    announceToScreenReader('Ukuran font diperkecil');
  }
}

function updateFontSizeButtons() {
  const incBtn = document.getElementById('fontIncrease');
  const decBtn = document.getElementById('fontDecrease');
  
  incBtn.disabled = AppState.fontSize >= 24;
  decBtn.disabled = AppState.fontSize <= 14;
  
  incBtn.style.opacity = incBtn.disabled ? '0.5' : '1';
  decBtn.style.opacity = decBtn.disabled ? '0.5' : '1';
}

function toggleSpeech() {
  AppState.speechEnabled = !AppState.speechEnabled;
  const speechBtn = document.getElementById('speechToggle');
  const voiceStatus = document.getElementById('voiceStatus');
  const voiceIcon = document.getElementById('voiceIcon');
  const voiceText = document.getElementById('voiceText');
  
  speechBtn.innerHTML = AppState.speechEnabled ? '🔊' : '🔇';
  speechBtn.title = AppState.speechEnabled ? 'Matikan Suara' : 'Nyalakan Suara';
  localStorage.setItem('speechEnabled', AppState.speechEnabled);
  
  // Update voice status indicator
  if (AppState.speechEnabled) {
    voiceStatus.classList.add('active');
    voiceIcon.textContent = '🔊';
    voiceText.textContent = 'Suara aktif';
  } else {
    voiceStatus.classList.remove('active');
    voiceIcon.textContent = '🔇';
    voiceText.textContent = 'Suara tidak aktif';
  }
  
  if (AppState.speechEnabled) {
    speakText('Asisten suara diaktifkan');
  }
}

/* ===== TEXT-TO-SPEECH SYSTEM ===== */
function speakText(text, options = {}) {
  if (!AppState.speechEnabled || !window.speechSynthesis) return;
  
  // Cancel any ongoing speech
  window.speechSynthesis.cancel();
  
  // Remove markdown and special characters
  const cleanText = text
    .replace(/\*\*/g, '')
    .replace(/\*/g, '')
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
    .replace(/📚|🔗|✓|→/g, '')
    .trim();
  
  const utterance = new SpeechSynthesisUtterance(cleanText);
  utterance.lang = options.lang || AppState.language;
  utterance.rate = options.rate || 0.9;
  utterance.pitch = options.pitch || 1;
  utterance.volume = options.volume || 1;
  
  // Get Indonesian voice if available
  const voices = window.speechSynthesis.getVoices();
  const indonesianVoice = voices.find(voice => voice.lang.startsWith('id'));
  if (indonesianVoice) {
    utterance.voice = indonesianVoice;
  }
  
  window.speechSynthesis.speak(utterance);
}

/* ===== ACCESSIBILITY HELPERS ===== */
function announceToScreenReader(message) {
  const announcement = document.createElement('div');
  announcement.setAttribute('role', 'status');
  announcement.setAttribute('aria-live', 'polite');
  announcement.className = 'sr-only';
  announcement.textContent = message;
  document.body.appendChild(announcement);
  
  setTimeout(() => {
    document.body.removeChild(announcement);
  }, 1000);
}

/* ===== MODAL MANAGEMENT ===== */
function openModal(modalId) {
  const modal = document.getElementById(modalId);
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  
  // Focus management
  const focusableElements = modal.querySelectorAll(
    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
  );
  if (focusableElements.length) {
    focusableElements[0].focus();
  }
  
  // Trap focus
  modal.addEventListener('keydown', trapFocus);
  
  // Announce modal opening
  const title = modal.querySelector('[id$="-title"]')?.textContent || 'Modal';
  announceToScreenReader(`${title} dibuka`);
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  modal.classList.add('hidden');
  modal.classList.remove('flex');
  
  // Remove focus trap
  modal.removeEventListener('keydown', trapFocus);
  
  // Return focus to trigger element if available
  if (modal.triggerElement) {
    modal.triggerElement.focus();
  }
}

function trapFocus(e) {
  if (e.key !== 'Tab') return;
  
  const modal = e.currentTarget;
  const focusableElements = modal.querySelectorAll(
    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
  );
  
  const firstFocusable = focusableElements[0];
  const lastFocusable = focusableElements[focusableElements.length - 1];
  
  if (e.shiftKey && document.activeElement === firstFocusable) {
    e.preventDefault();
    lastFocusable.focus();
  } else if (!e.shiftKey && document.activeElement === lastFocusable) {
    e.preventDefault();
    firstFocusable.focus();
  }
}

/* ===== SCREENING FUNCTIONS ===== */
function openScreening() {
  document.getElementById('screeningModal').triggerElement = document.activeElement;
  openModal('screeningModal');
  updateScreeningProgress();
}

function closeScreening() {
  closeModal('screeningModal');
  resetScreeningForm();
}

function updateScreeningProgress() {
  const form = document.getElementById('screeningForm');
  const requiredInputs = form.querySelectorAll('[required]');
  const filledInputs = Array.from(requiredInputs).filter(input => {
    if (input.type === 'radio') {
      return form.querySelector(`input[name="${input.name}"]:checked`);
    }
    return input.value.trim() !== '';
  });
  
  const progress = Math.round((filledInputs.length / requiredInputs.length) * 100);
  document.getElementById('screeningProgress').textContent = `${progress}%`;
  document.getElementById('progressBar').style.width = `${progress}%`;
}

function resetScreeningForm() {
  document.getElementById('screeningForm').reset();
  document.getElementById('screeningResult').classList.add('hidden');
  updateScreeningProgress();
}

// Enhanced screening form handler
document.getElementById('screeningForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  // Show loading state
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="animate-pulse">⏳ Menganalisis data...</span>';
  
  try {
    // Collect all form data
    const formData = new FormData(e.target);
    const screeningData = Object.fromEntries(formData);
    
    // Calculate screening score
    const screeningItems = [
      'vision', 'hearing', 'balance', 'nutrition', 'incontinence',
      'depression', 'cognitive', 'polypharmacy', 'adl', 'social',
      'sleep', 'pain', 'hospitalization', 'support'
    ];
    
    let totalScore = 0;
    const positiveItems = [];
    
    screeningItems.forEach(item => {
      const value = parseInt(screeningData[item] || 0);
      totalScore += value;
      if (value === 1) {
        positiveItems.push(item);
      }
    });
    
    // Store data
    AppState.screeningData = {
      ...screeningData,
      totalScore,
      positiveItems,
      timestamp: new Date().toISOString()
    };
    
    // Display comprehensive result
    displayEnhancedScreeningResult(totalScore, positiveItems, screeningData);
    
  } catch (error) {
    console.error('Screening error:', error);
    alert('Terjadi kesalahan. Silakan coba lagi.');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
  }
});

// Add change listeners for progress updates
document.getElementById('screeningForm').addEventListener('change', updateScreeningProgress);
document.getElementById('screeningForm').addEventListener('input', updateScreeningProgress);

function displayEnhancedScreeningResult(score, positiveItems, data) {
  let risk, riskClass, color, recommendations, aiInsights;
  
  // Determine risk level
  if (score >= 8) {
    risk = 'TINGGI';
    riskClass = 'risk-high';
    color = 'text-red-600';
    recommendations = [
      '🚨 Rujuk segera ke dokter spesialis geriatri',
      '📋 Lakukan Comprehensive Geriatric Assessment (CGA) lengkap',
      '👥 Bentuk tim perawatan multidisiplin',
      '📅 Follow-up ketat setiap 2 minggu',
      '💊 Review semua obat dengan farmasis klinis',
      '🏥 Pertimbangkan program geriatri terpadu'
    ];
    aiInsights = `Pasien memiliki ${score} dari 14 domain geriatri yang positif, menunjukkan kompleksitas tinggi dan kebutuhan intervensi segera. Domain prioritas: ${positiveItems.slice(0, 3).join(', ')}.`;
  } else if (score >= 5) {
    risk = 'SEDANG';
    riskClass = 'risk-medium';
    color = 'text-orange-600';
    recommendations = [
      '🏥 Konsultasi dokter geriatri dalam 1 minggu',
      '🔍 Screening lanjutan untuk domain positif',
      '📚 Ikuti program edukasi geriatri',
      '📅 Follow-up bulanan',
      '💊 Evaluasi obat-obatan',
      '🏃‍♂️ Mulai program exercise therapy'
    ];
    aiInsights = `Ditemukan ${score} domain positif yang memerlukan perhatian. Fokus intervensi pada: ${positiveItems.join(', ')}.`;
  } else if (score >= 2) {
    risk = 'RENDAH';
    riskClass = 'risk-low';
    color = 'text-yellow-600';
    recommendations = [
      '📋 Monitoring berkala setiap 3 bulan',
      '🎓 Edukasi pencegahan primer',
      '🔄 Screening ulang 6 bulan',
      '🏃‍♂️ Pertahankan aktivitas fisik',
      '🥗 Optimasi nutrisi',
      '👥 Aktif dalam kegiatan sosial'
    ];
    aiInsights = `Status geriatri relatif baik dengan ${score} domain minor. Fokus pada pencegahan dan maintenance.`;
  } else {
    risk = 'MINIMAL';
    riskClass = 'risk-minimal';
    color = 'text-green-600';
    recommendations = [
      '✅ Status geriatri sangat baik',
      '🎯 Pertahankan gaya hidup sehat',
      '📅 Screening tahunan rutin',
      '🏃‍♂️ Lanjutkan aktivitas fisik teratur',
      '🧠 Stimulasi kognitif berkelanjutan',
      '👥 Pertahankan jejaring sosial aktif'
    ];
    aiInsights = 'Status kesehatan geriatri sangat baik. Lanjutkan gaya hidup sehat saat ini.';
  }
  
  // Generate comprehensive report
  const resultDiv = document.getElementById('screeningResult');
  resultDiv.innerHTML = `
    <div class="space-y-6 animate-fade-in">
      <!-- Risk Summary Card -->
      <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
        <div class="text-center mb-6">
          <h4 class="text-2xl font-bold mb-4">📊 Hasil Comprehensive Geriatric Screening</h4>
          <div class="inline-flex items-center ${riskClass} px-6 py-3 rounded-full text-lg font-bold">
            <span class="text-3xl mr-3">${score}/14</span>
            <span>Risiko ${risk}</span>
          </div>
        </div>
        
        <!-- Patient Info -->
        <div class="grid md:grid-cols-2 gap-4 mb-6 text-sm">
          <div><strong>Nama:</strong> ${data.patientName || 'N/A'}</div>
          <div><strong>Usia:</strong> ${data.patientAge || 'N/A'} tahun</div>
          <div><strong>No. RM:</strong> ${data.patientRM || 'N/A'}</div>
          <div><strong>Tanggal:</strong> ${new Date().toLocaleDateString('id-ID')}</div>
        </div>
        
        <!-- AI Analysis -->
        <div class="knowledge-card mb-6">
          <h5 class="font-semibold mb-2 flex items-center gap-2">
            <span>🤖</span> Analisis Klinis AI
          </h5>
          <p class="text-sm">${aiInsights}</p>
        </div>
        
        <!-- Risk Visualization -->
        <div class="mb-6">
          <canvas id="riskChart" width="300" height="300"></canvas>
        </div>
        
        <!-- Positive Domains -->
        ${positiveItems.length > 0 ? `
          <div class="mb-6">
            <h5 class="font-semibold mb-3">🔍 Domain yang Memerlukan Intervensi:</h5>
            <div class="grid md:grid-cols-2 gap-2">
              ${positiveItems.map(item => {
                const domainInfo = getDomainInfo(item);
                return `
                  <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-3 text-sm">
                    <div class="font-medium text-red-700 dark:text-red-300">${domainInfo.name}</div>
                    <div class="text-xs text-gray-600 dark:text-gray-400">${domainInfo.intervention}</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        ` : ''}
        
        <!-- Recommendations -->
        <div class="mb-6">
          <h5 class="font-semibold mb-3">💡 Rekomendasi Tindak Lanjut:</h5>
          <div class="space-y-2">
            ${recommendations.map(rec => `
              <div class="flex items-start text-sm">
                <span class="text-green-500 mr-2 mt-0.5">✓</span>
                <span>${rec}</span>
              </div>
            `).join('')}
          </div>
        </div>
        
        <!-- Evidence-Based Guidelines -->
        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 mb-6">
          <h5 class="font-semibold mb-2 text-blue-700 dark:text-blue-300">📚 Panduan Klinis Terkait:</h5>
          <ul class="text-sm space-y-1">
            ${getRelevantGuidelines(positiveItems).map(guide => `
              <li>• ${guide.text} <a href="${guide.url}" target="_blank" class="text-blue-500 hover:underline text-xs">[${guide.source}]</a></li>
            `).join('')}
          </ul>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-3 justify-center">
          <button onclick="printScreeningReport()" class="elderly-friendly-btn bg-blue-500 text-white">
            🖨️ Cetak Laporan
          </button>
          <button onclick="downloadScreeningPDF()" class="elderly-friendly-btn bg-green-500 text-white">
            📄 Download PDF
          </button>
          <button onclick="shareScreeningResult()" class="elderly-friendly-btn bg-purple-500 text-white">
            📤 Bagikan Hasil
          </button>
          <button onclick="scheduleFollowUp()" class="elderly-friendly-btn bg-orange-500 text-white">
            📅 Jadwalkan Follow-up
          </button>
          <button onclick="openChatWithContext()" class="elderly-friendly-btn bg-gradient-to-r from-purple-500 to-pink-500 text-white">
            💬 Konsultasi AI
          </button>
        </div>
      </div>
    </div>
  `;
  
  resultDiv.classList.remove('hidden');
  
  // Create risk visualization chart
  setTimeout(() => {
    createRiskChart(score, positiveItems);
  }, 100);
  
  // Speak result
  speakText(`Hasil screening geriatri menunjukkan skor ${score} dari 14 dengan tingkat risiko ${risk}. ${aiInsights}`);
  
  // Scroll to result
  resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function getDomainInfo(domain) {
  const domainMap = {
    vision: { name: 'Gangguan Penglihatan', intervention: 'Rujuk oftalmologi, evaluasi katarak' },
    hearing: { name: 'Gangguan Pendengaran', intervention: 'Audiometri, pertimbangkan alat bantu dengar' },
    balance: { name: 'Gangguan Keseimbangan', intervention: 'Fall risk assessment, fisioterapi' },
    nutrition: { name: 'Risiko Malnutrisi', intervention: 'Konsultasi gizi, MNA assessment' },
    incontinence: { name: 'Inkontinensia', intervention: 'Bladder training, rujuk urologi' },
    depression: { name: 'Gejala Depresi', intervention: 'GDS-15, konsultasi psikiatri' },
    cognitive: { name: 'Gangguan Kognitif', intervention: 'MMSE/MoCA, rujuk neurologi' },
    polypharmacy: { name: 'Polifarmasi', intervention: 'Medication review, deprescribing' },
    adl: { name: 'Gangguan ADL', intervention: 'Occupational therapy, caregiver training' },
    social: { name: 'Isolasi Sosial', intervention: 'Social worker, day care program' },
    sleep: { name: 'Gangguan Tidur', intervention: 'Sleep hygiene, polysomnography if needed' },
    pain: { name: 'Nyeri Kronis', intervention: 'Pain assessment, multimodal analgesia' },
    hospitalization: { name: 'Riwayat Rawat Inap', intervention: 'Review discharge plan, home care' },
    support: { name: 'Kurang Dukungan', intervention: 'Social services, community resources' }
  };
  
  return domainMap[domain] || { name: domain, intervention: 'Evaluasi lebih lanjut' };
}

function getRelevantGuidelines(positiveItems) {
  const guidelines = [];
  
  if (positiveItems.includes('balance') || positiveItems.includes('fall')) {
    guidelines.push({
      text: 'Intervensi pencegahan jatuh untuk lansia',
      source: 'NICE CG161',
      url: 'https://www.nice.org.uk/guidance/cg161'
    });
  }
  
  if (positiveItems.includes('polypharmacy')) {
    guidelines.push({
      text: 'Kriteria START/STOPP untuk optimasi terapi',
      source: 'O\'Mahony 2023',
      url: 'https://pubmed.ncbi.nlm.nih.gov/25324330/'
    });
  }
  
  if (positiveItems.includes('cognitive')) {
    guidelines.push({
      text: 'Asesmen dan manajemen demensia',
      source: 'WHO 2023',
      url: 'https://www.who.int/publications/i/item/9789240033245'
    });
  }
  
  if (positiveItems.includes('nutrition')) {
    guidelines.push({
      text: 'Nutrisi klinis pada penuaan',
      source: 'ESPEN 2022',
      url: 'https://www.espen.org/guidelines-home'
    });
  }
  
  // Add general guideline
  guidelines.push({
    text: 'Perawatan terintegrasi untuk orang tua (ICOPE)',
    source: 'WHO',
    url: 'https://www.who.int/publications/i/item/9789241515627'
  });
  
  return guidelines;
}

function createRiskChart(score, positiveItems) {
  const ctx = document.getElementById('riskChart');
  if (!ctx) return;
  
  // Domain categories
  const categories = {
    'Fisik': ['vision', 'hearing', 'balance', 'pain'],
    'Kognitif & Mental': ['cognitive', 'depression'],
    'Fungsional': ['adl', 'incontinence'],
    'Sosial': ['social', 'support'],
    'Medis': ['polypharmacy', 'nutrition', 'hospitalization', 'sleep']
  };
  
  // Calculate scores per category
  const categoryScores = {};
  Object.keys(categories).forEach(cat => {
    categoryScores[cat] = categories[cat].filter(item => positiveItems.includes(item)).length;
  });
  
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: Object.keys(categoryScores),
      datasets: [{
        data: Object.values(categoryScores),
        backgroundColor: [
          'rgba(239, 68, 68, 0.8)',   // red
          'rgba(245, 158, 11, 0.8)',  // amber
          'rgba(59, 130, 246, 0.8)',  // blue
          'rgba(147, 51, 234, 0.8)',  // purple
          'rgba(16, 185, 129, 0.8)'   // emerald
        ],
        borderColor: [
          'rgb(239, 68, 68)',
          'rgb(245, 158, 11)',
          'rgb(59, 130, 246)',
          'rgb(147, 51, 234)',
          'rgb(16, 185, 129)'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 15,
            font: {
              size: 12
            }
          }
        },
        title: {
          display: true,
          text: 'Distribusi Domain Geriatri Positif',
          font: {
            size: 14,
            weight: 'bold'
          }
        }
      }
    }
  });
}

/* ===== ENHANCED CHAT SYSTEM ===== */
function openChat() {
  document.getElementById('chatModal').triggerElement = document.activeElement;
  openModal('chatModal');
  document.getElementById('chatInput').focus();
  
  // Load chat history
  if (AppState.chatHistory.length === 0) {
    initializeChatGreeting();
  }
}

function closeChat() {
  closeModal('chatModal');
}

function initializeChatGreeting() {
  const greeting = `👋 Halo! Saya Asisten GeriatriCare Pro AI dengan akses ke:
✓ 500+ referensi medis (WHO, IAGG, Kemenkes)
✓ Protokol geriatri berbasis evidence
✓ Pemeriksa interaksi obat real-time
✓ Rekomendasi kesehatan personal
Silakan tanyakan apa saja tentang kesehatan geriatri!`;
  
  appendMessage('bot', greeting);
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  
  if (!message) return;
  
  // Clear input and append user message
  input.value = '';
  appendMessage('user', message);
  
  // Show typing indicator
  showTypingIndicator();
  
  try {
    // Get AI response
    const response = await geriatricAI.generateResponse(message, {
      context: AppState.screeningData,
      mode: 'chat'
    });
    
    // Remove typing indicator and append response
    hideTypingIndicator();
    appendMessage('bot', response);
    
    // Speak response
    speakText(response);
    
  } catch (error) {
    hideTypingIndicator();
    appendMessage('bot', 'Maaf, terjadi kesalahan. Silakan coba lagi.');
  }
}

function sendQuickMessage(type) {
  const quickMessages = {
    screening: 'Bagaimana cara melakukan screening geriatri yang komprehensif?',
    medication: 'Saya ingin mengecek interaksi obat untuk lansia',
    fall: 'Apa saja cara efektif mencegah jatuh pada lansia?',
    nutrition: 'Bagaimana kebutuhan nutrisi khusus untuk lansia?'
  };
  
  const message = quickMessages[type];
  if (message) {
    document.getElementById('chatInput').value = message;
    sendMessage();
  }
}

function appendMessage(sender, text) {
  const chatBody = document.getElementById('chatBody');
  const messageDiv = document.createElement('div');
  
  messageDiv.className = sender === 'user' 
    ? 'chat-user text-white p-4 rounded-2xl rounded-br-md max-w-[80%] ml-auto text-sm shadow-lg' 
    : 'chat-bot text-white p-4 rounded-2xl rounded-bl-md max-w-[80%] text-sm shadow-lg';
  
  // Parse markdown-style formatting
  const formattedText = formatChatMessage(text);
  messageDiv.innerHTML = formattedText;
  
  chatBody.appendChild(messageDiv);
  
  // Add to history
  AppState.chatHistory.push({
    sender,
    text,
    timestamp: new Date().toISOString()
  });
  
  // Scroll to bottom
  chatBody.scrollTop = chatBody.scrollHeight;
}

function formatChatMessage(text) {
  // Convert markdown to HTML
  let formatted = text
    // Bold
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    // Links
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="underline hover:no-underline">$1</a>')
    // Line breaks
    .replace(/\n\n/g, '</p><p class="mt-2">')
    .replace(/\n/g, '<br>')
    // Lists
    .replace(/^- (.+)$/gm, '<li class="ml-4">• $1</li>')
    .replace(/^✓ (.+)$/gm, '<li class="ml-4">✓ $1</li>')
    // References
    .replace(/📚 (.+)$/gm, '<div class="mt-3 pt-3 border-t border-white/20 text-xs">📚 $1</div>')
    .replace(/🔗 (.+)$/gm, '<div class="text-xs">🔗 $1</div>');
  
  // Wrap in paragraph if not already
  if (!formatted.includes('<p')) {
    formatted = `<p>${formatted}</p>`;
  }
  
  return formatted;
}

function showTypingIndicator() {
  const chatBody = document.getElementById('chatBody');
  const typingDiv = document.createElement('div');
  typingDiv.id = 'typingIndicator';
  typingDiv.className = 'chat-bot text-white p-3 rounded-2xl rounded-bl-md max-w-xs text-sm';
  typingDiv.innerHTML = `
    <div class="flex items-center space-x-2">
      <div class="w-2 h-2 bg-white/60 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
      <div class="w-2 h-2 bg-white/60 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
      <div class="w-2 h-2 bg-white/60 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
    </div>
  `;
  chatBody.appendChild(typingDiv);
  chatBody.scrollTop = chatBody.scrollHeight;
}

function hideTypingIndicator() {
  const indicator = document.getElementById('typingIndicator');
  if (indicator) {
    indicator.remove();
  }
}

// Voice input functionality
function toggleVoiceInput() {
  if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
    alert('Maaf, browser Anda tidak mendukung input suara.');
    return;
  }
  
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();
  
  recognition.lang = AppState.language;
  recognition.continuous = false;
  recognition.interimResults = false;
  
  recognition.onstart = () => {
    announceToScreenReader('Mendengarkan...');
    document.querySelector('[onclick="toggleVoiceInput()"]').classList.add('animate-pulse', 'bg-red-500');
  };
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    document.getElementById('chatInput').value = transcript;
    sendMessage();
  };
  
  recognition.onerror = (event) => {
    console.error('Speech recognition error:', event.error);
    alert('Terjadi kesalahan pada input suara. Silakan coba lagi.');
  };
  
  recognition.onend = () => {
    document.querySelector('[onclick="toggleVoiceInput()"]').classList.remove('animate-pulse', 'bg-red-500');
  };
  
  recognition.start();
}

// Chat input handling
document.getElementById('chatInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// Auto-resize textarea
document.getElementById('chatInput').addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

/* ===== KNOWLEDGE BASE FUNCTIONS ===== */
function openKnowledgeBase() {
  document.getElementById('knowledgeModal').triggerElement = document.activeElement;
  openModal('knowledgeModal');
  loadKnowledgeCategories();
}

function closeKnowledgeBase() {
  closeModal('knowledgeModal');
}

function loadKnowledgeCategories() {
  // Categories are already rendered in HTML
  // This function can be used to dynamically load categories if needed
}

function searchKnowledgeBase(query) {
  if (!query) {
    document.getElementById('kbContent').innerHTML = '';
    return;
  }
  
  const results = geriatricAI.searchKnowledge(query);
  displayKnowledgeResults(results);
}

function displayKnowledgeResults(results) {
  const contentDiv = document.getElementById('kbContent');
  
  if (results.length === 0) {
    contentDiv.innerHTML = '<p class="text-center text-gray-500">Tidak ditemukan hasil.</p>';
    return;
  }
  
  contentDiv.innerHTML = `
    <h4 class="font-semibold mb-4">Hasil Pencarian (${results.length})</h4>
    <div class="space-y-4">
      ${results.map(item => `
        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 hover:shadow-lg transition-shadow cursor-pointer" onclick="showKBDetail('${item.id}')">
          <h5 class="font-semibold text-lg mb-2">${item.title}</h5>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">${item.content.substring(0, 200)}...</p>
          <div class="flex items-center justify-between">
            <div class="flex flex-wrap gap-2">
              ${item.tags.slice(0, 3).map(tag => `
                <span class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded-full">${tag}</span>
              `).join('')}
            </div>
            <button class="text-blue-500 hover:text-blue-700 text-sm font-medium">Baca Selengkapnya →</button>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

function showKBContent(contentId) {
  const content = getKBContent(contentId);
  const contentDiv = document.getElementById('kbContent');
  
  contentDiv.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6">
      <h4 class="font-bold text-xl mb-4">${content.title}</h4>
      <div class="prose dark:prose-invert max-w-none">
        ${content.body}
      </div>
      ${content.references ? `
        <div class="mt-6 pt-4 border-t dark:border-gray-700">
          <h5 class="font-semibold mb-2">Referensi:</h5>
          <ul class="space-y-1">
            ${content.references.map(ref => `
              <li class="text-sm">
                <a href="${ref.url}" target="_blank" class="text-blue-500 hover:underline">${ref.title}</a>
              </li>
            `).join('')}
          </ul>
        </div>
      ` : ''}
    </div>
  `;
  
  contentDiv.scrollIntoView({ behavior: 'smooth' });
}

function getKBContent(contentId) {
  // This would fetch from a real knowledge base
  const contentMap = {
    'who-icope': {
      title: 'Buku Panduan WHO ICOPE 2023',
      body: `
        <h3>Integrated Care for Older People (ICOPE)</h3>
        <p>ICOPE adalah pendekatan WHO untuk mengoptimalkan kapasitas intrinsik lansia melalui:</p>
        <ol>
          <li><strong>Screening 6 domain:</strong> Mobilitas, Nutrisi, Penglihatan, Pendengaran, Kognitif, Mood</li>
          <li><strong>Assessment mendalam</strong> untuk domain yang positif</li>
          <li><strong>Care plan personal</strong> berbasis hasil assessment</li>
          <li><strong>Monitoring berkala</strong> dan penyesuaian intervensi</li>
        </ol>
        <h4>Implementasi di Fasilitas Kesehatan:</h4>
        <ul>
          <li>Training tenaga kesehatan tentang ICOPE</li>
          <li>Integrasi dengan sistem EMR existing</li>
          <li>Pathway rujukan yang jelas</li>
          <li>Monitoring outcomes</li>
        </ul>
      `,
      references: [
        { title: 'WHO ICOPE Implementation Framework', url: 'https://www.who.int/publications/i/item/9789241515993' },
        { title: 'ICOPE App and Digital Tools', url: 'https://www.who.int/teams/maternal-newborn-child-adolescent-health-and-ageing/icope' }
      ]
    },
    'ags-beers': {
      title: 'Kriteria AGS Beers 2023',
      body: `
        <h3>Potentially Inappropriate Medications (PIMs) untuk Lansia</h3>
        <h4>Kategori Utama:</h4>
        <ol>
          <li><strong>PIM Independent of Diagnosis:</strong>
            <ul>
              <li>Anticholinergics (diphenhydramine, hydroxyzine)</li>
              <li>Benzodiazepines (diazepam, alprazolam)</li>
              <li>Non-benzodiazepine hypnotics (zolpidem)</li>
              <li>Antipsychotics as first-line for insomnia</li>
            </ul>
          </li>
          <li><strong>PIM Due to Drug-Disease Interactions:</strong>
            <ul>
              <li>NSAIDs dengan CKD, Heart Failure</li>
              <li>Anticholinergics dengan Dementia, BPH</li>
              <li>Benzodiazepines dengan History of Falls</li>
            </ul>
          </li>
          <li><strong>Medications to Use with Caution:</strong>
            <ul>
              <li>Aspirin untuk primary prevention ≥70 tahun</li>
              <li>Dabigatran, Rivaroxaban ≥75 tahun atau CrCl <30</li>
              <li>SSRI (risiko hiponatremia, falls)</li>
            </ul>
          </li>
        </ol>
        <h4>Prinsip Deprescribing:</h4>
        <p>Start Low, Go Slow, But Go!</p>
      `,
      references: [
        { title: 'AGS Beers Criteria 2023 Full Text', url: 'https://agsjournals.onlinelibrary.wiley.com/doi/10.1111/jgs.18372' },
        { title: 'Beers Criteria Pocket Card', url: 'https://www.americangeriatrics.org/programs/beers-criteria' }
      ]
    },
    'drug-interactions': {
      title: 'Pemeriksa Interaksi Obat',
      body: `
        <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg mb-4">
          <h4 class="font-semibold mb-2">⚠️ Common Drug Interactions in Elderly</h4>
        </div>
        <div id="drugInteractionTool">
          <h4>Interactive Drug Checker:</h4>
          <input type="text" id="drug1" placeholder="Masukkan obat 1..." class="w-full p-2 border rounded mb-2">
          <input type="text" id="drug2" placeholder="Masukkan obat 2..." class="w-full p-2 border rounded mb-2">
          <button onclick="checkDrugInteraction()" class="bg-blue-500 text-white px-4 py-2 rounded">Check Interaction</button>
          <div id="interactionResult" class="mt-4"></div>
        </div>
        <h4 class="mt-6">High-Risk Combinations:</h4>
        <ul>
          <li><strong>Warfarin + NSAIDs:</strong> ↑ bleeding risk</li>
          <li><strong>ACE-I + Spironolactone:</strong> Hyperkalemia</li>
          <li><strong>Digoxin + Amiodarone:</strong> Digoxin toxicity</li>
          <li><strong>SSRIs + NSAIDs:</strong> GI bleeding</li>
        </ul>
      `
    }
  };
  
  return contentMap[contentId] || { title: 'Content Not Found', body: 'The requested content is not available.' };
}

function showKBDetail(itemId) {
  const item = KNOWLEDGE_DB.find(k => k.id === itemId);
  if (!item) return;
  
  const contentDiv = document.getElementById('kbContent');
  contentDiv.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6">
      <button onclick="searchKnowledgeBase('')" class="text-blue-500 hover:underline mb-4">← Kembali</button>
      <h4 class="font-bold text-xl mb-2">${item.title}</h4>
      <div class="flex flex-wrap gap-2 mb-4">
        ${item.tags.map(tag => `
          <span class="text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-2 py-1 rounded-full">${tag}</span>
        `).join('')}
      </div>
      <div class="prose dark:prose-invert max-w-none mb-6">
        <p>${item.content}</p>
      </div>
      ${item.references.length > 0 ? `
        <div class="border-t dark:border-gray-700 pt-4">
          <h5 class="font-semibold mb-2">📚 Referensi:</h5>
          <ul class="space-y-2">
            ${item.references.map(ref => `
              <li class="flex items-start gap-2">
                <span class="text-blue-500 mt-1">→</span>
                <div>
                  <a href="${ref.url}" target="_blank" class="text-blue-500 hover:underline font-medium">${ref.source}</a>
                  <p class="text-sm text-gray-600 dark:text-gray-400">${ref.url}</p>
                </div>
              </li>
            `).join('')}
          </ul>
        </div>
      ` : ''}
    </div>
  `;
}

/* ===== PORTAL FUNCTIONS ===== */
function openPatientPortal() {
  showFeatureDemo('Portal Pasien', `
    <div class="space-y-4">
      <h4 class="font-semibold">Portal Pasien - Fitur:</h4>
      <ul class="space-y-2">
        <li>✓ Akses 24/7 ke rekam medis elektronik</li>
        <li>✓ Hasil lab dan radiologi real-time</li>
        <li>✓ Jadwal kontrol dan reminder otomatis</li>
        <li>✓ Riwayat pengobatan lengkap</li>
        <li>✓ Integrasi telemedicine</li>
        <li>✓ E-prescription dan delivery obat</li>
      </ul>
      <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
        <p class="text-sm">Login dengan NIK dan tanggal lahir untuk akses penuh.</p>
      </div>
    </div>
  `);
}

function openFamilyDashboard() {
  showFeatureDemo('Dashboard Keluarga', `
    <div class="space-y-4">
      <h4 class="font-semibold">Koordinasi Perawatan Keluarga:</h4>
      <ul class="space-y-2">
        <li>✓ Dashboard pemantauan kesehatan real-time</li>
        <li>✓ Pelacakan kepatuhan minum obat</li>
        <li>✓ Peringatan jatuh</li>
        <li>✓ Penjadwalan kontrol untuk lansia</li>
        <li>✓ Komunikasi tim perawatan</li>
        <li>✓ Sistem kontak darurat</li>
      </ul>
      <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
        <p class="text-sm">Akses multi-user dengan tingkat izin yang berbeda.</p>
      </div>
    </div>
  `);
}

function openClinicianHub() {
  showFeatureDemo('Pusat Klinisi', `
    <div class="space-y-4">
      <h4 class="font-semibold">Alat Klinis Berbasis AI:</h4>
      <ul class="space-y-2">
        <li>✓ Sistem pendukung keputusan klinis</li>
        <li>✓ Form asesmen terisi otomatis</li>
        <li>✓ Protokol perawatan berbasis evidence</li>
        <li>✓ CPOE terintegrasi dengan pemeriksa interaksi</li>
        <li>✓ Dashboard analitik prediktif</li>
        <li>✓ Perencanaan perawatan multidisiplin</li>
      </ul>
      <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
        <p class="text-sm">Memerlukan verifikasi lisensi medis untuk akses penuh.</p>
      </div>
    </div>
  `);
}

function openPoliDetail(specialty) {
  const poliInfo = {
    cardio: {
      name: 'Kardio-Geriatri',
      description: 'Perawatan jantung khusus untuk lansia dengan fokus pada gagal jantung, aritmia, dan penyakit jantung koroner.',
      services: ['Interpretasi EKG dengan AI', 'Echocardiography', 'Monitoring Holter', 'Rehabilitasi jantung'],
      protocols: 'Pedoman ESC yang diadaptasi untuk lansia'
    },
    internal: {
      name: 'Penyakit Dalam',
      description: 'Manajemen penyakit metabolik dan sistemik yang komprehensif.',
      services: ['Manajemen Diabetes', 'Kontrol Hipertensi', 'Gangguan Tiroid', 'Perawatan penyakit kronis'],
      protocols: 'Pedoman ACP untuk orang dewasa lanjut usia'
    },
    neuro: {
      name: 'Neuro-Geriatri',
      description: 'Perawatan demensia, rehabilitasi stroke, dan gangguan gerakan.',
      services: ['Asesmen kognitif', 'Staging demensia', 'Rehab stroke', 'Manajemen Parkinson'],
      protocols: 'Pedoman Dementia AAN'
    },
    ortho: {
      name: 'Orto-Geriatri',
      description: 'Pencegahan fraktur, perawatan sendi, dan optimasi mobilitas.',
      services: ['Pemindaian DEXA', 'Asesmen risiko jatuh', 'Injeksi sendi', 'Layanan fraktur liaison'],
      protocols: 'Pedoman fraktur geriatri AAOS'
    },
    nutrition: {
      name: 'Gizi Klinis',
      description: 'Pencegahan malnutrisi dan nutrisi terapeutik.',
      services: ['Asesmen MNA', 'Konseling gizi', 'Nutrisi enteral', 'Manajemen sarkopenia'],
      protocols: 'Pedoman gizi klinis ESPEN'
    },
    rehab: {
      name: 'Rehabilitasi Medis',
      description: 'Restorasi fungsional dan pencegahan disabilitas.',
      services: ['Analisis gait', 'Latihan keseimbangan', 'Terapi okupasi', 'Alat bantu'],
      protocols: 'Pedoman rehabilitasi WHO'
    }
  };
  
  const info = poliInfo[specialty];
  showFeatureDemo(`Poli ${info.name}`, `
    <div class="space-y-4">
      <p class="text-gray-600 dark:text-gray-400">${info.description}</p>
      <div>
        <h5 class="font-semibold mb-2">Layanan Tersedia:</h5>
        <ul class="space-y-1">
          ${info.services.map(service => `<li class="text-sm">• ${service}</li>`).join('')}
        </ul>
      </div>
      <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg">
        <p class="text-sm font-medium">Protokol Klinis: ${info.protocols}</p>
      </div>
      <button onclick="schedulePoliAppointment('${specialty}')" class="elderly-friendly-btn bg-blue-500 text-white">
        Jadwalkan Konsultasi
      </button>
    </div>
  `);
}

function showFeatureDemo(title, content) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-md z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-lg w-full shadow-2xl">
      <h3 class="text-xl font-bold mb-4">${title}</h3>
      ${content}
      <button onclick="this.closest('.fixed').remove()" class="mt-6 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
        Tutup
      </button>
    </div>
  `;
  document.body.appendChild(modal);
}

/* ===== UTILITY FUNCTIONS ===== */
function openChatWithContext() {
  openChat();
  
  // Send screening context to chat
  if (AppState.screeningData.totalScore !== undefined) {
    setTimeout(() => {
      const contextMessage = `Saya baru saja melakukan screening geriatri dengan hasil skor ${AppState.screeningData.totalScore}/14. Domain positif: ${AppState.screeningData.positiveItems.join(', ')}. Apa rekomendasi Anda?`;
      document.getElementById('chatInput').value = contextMessage;
      sendMessage();
    }, 500);
  }
}

function printScreeningReport() {
  window.print();
}

function downloadScreeningPDF() {
  // This would integrate with a PDF generation library
  alert('Fitur download PDF akan segera tersedia. Gunakan fungsi Print dan pilih "Save as PDF" untuk sementara.');
}

function shareScreeningResult() {
  if (navigator.share) {
    navigator.share({
      title: 'Hasil Screening Geriatri',
      text: `Hasil screening geriatri: Skor ${AppState.screeningData.totalScore}/14`,
      url: window.location.href
    }).catch(console.error);
  } else {
    alert('Fungsi share tidak tersedia di browser ini.');
  }
}

function scheduleFollowUp() {
  showFeatureDemo('Jadwalkan Follow-up', `
    <form class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1">Pilih Tanggal</label>
        <input type="date" class="w-full p-2 border rounded" min="${new Date().toISOString().split('T')[0]}">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Pilih Poli</label>
        <select class="w-full p-2 border rounded">
          <option>Geriatri Umum</option>
          <option>Kardio-Geriatri</option>
          <option>Neuro-Geriatri</option>
        </select>
      </div>
      <button type="submit" class="elderly-friendly-btn w-full bg-orange-500 text-white">
        Konfirmasi Jadwal
      </button>
    </form>
  `);
}

function showDomainInfo(domain) {
  const info = getDomainInfo(domain);
  const detailedInfo = {
    vision: 'Gangguan penglihatan meliputi katarak, glaukoma, degenerasi makula. Screening: Snellen chart, fundoscopy.',
    hearing: 'Presbycusis umum pada lansia. Screening: Whisper test, audiometry. Pertimbangkan hearing aid.',
    balance: 'Risiko jatuh meningkat dengan usia. Assessment: Timed Up and Go, Berg Balance Scale.',
    nutrition: 'Malnutrisi tersembunyi sering terjadi. Use MNA-SF tool, check albumin, BMI.',
    incontinence: 'Bisa stress, urge, atau mixed. Evaluation: bladder diary, post-void residual.',
    depression: 'Prevalensi 10-15%. Screening: GDS-15, PHQ-9. First line: SSRI dengan monitoring.',
    cognitive: 'Mild Cognitive Impairment hingga dementia. Tools: MMSE, MoCA, clock drawing.',
    polypharmacy: '≥5 obat meningkatkan risiko interaksi. Review dengan Beers Criteria, START/STOPP.',
    adl: 'Basic ADL (mandi, makan) dan Instrumental ADL (belanja, finansial). Use Katz or Lawton scale.',
    social: 'Isolasi sosial = risiko mortalitas setara merokok. Assess support system, refer social services.',
    sleep: 'Sleep architecture berubah dengan aging. Avoid benzos, try sleep hygiene, consider melatonin.',
    pain: 'Chronic pain prevalensi 25-50%. Multimodal approach, avoid NSAIDs if possible.',
    hospitalization: 'Readmission risk tinggi. Need comprehensive discharge planning, medication reconciliation.',
    support: 'Caregiver burden assessment penting. Connect to respite care, support groups.'
  };
  
  showFeatureDemo(`Info: ${info.name}`, `
    <div class="space-y-3">
      <p class="text-sm">${detailedInfo[domain]}</p>
      <div class="bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded-lg">
        <p class="text-sm font-medium">Intervensi: ${info.intervention}</p>
      </div>
    </div>
  `);
}

// 3D Game functions
function startBalanceGame() {
  if (!AppState.game3D.scene) {
    AppState.game3D = new Game3D('gameContainer');
  }
  AppState.game3D.startBalanceGame();
}

function startMemoryGame() {
  if (!AppState.game3D.scene) {
    AppState.game3D = new Game3D('gameContainer');
  }
  AppState.game3D.startMemoryGame();
}

function startReactionGame() {
  if (!AppState.game3D.scene) {
    AppState.game3D = new Game3D('gameContainer');
  }
  AppState.game3D.startReactionGame();
}

// Additional feature implementations
function showPredictiveDemo() {
  showFeatureDemo('Demo Analitik Prediktif', `
    <div class="space-y-4">
      <div class="bg-gradient-to-r from-purple-100 to-pink-100 dark:from-purple-900/20 dark:to-pink-900/20 p-4 rounded-lg">
        <h5 class="font-semibold mb-2">Model Prediksi Risiko Jatuh</h5>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span>Kecepatan Gait:</span>
            <span class="font-medium">0.8 m/s</span>
          </div>
          <div class="flex justify-between">
            <span>Skor Keseimbangan:</span>
            <span class="font-medium">45/56</span>
          </div>
          <div class="flex justify-between">
            <span>Risiko Obat:</span>
            <span class="font-medium text-orange-600">Tinggi</span>
          </div>
          <div class="flex justify-between">
            <span>Jatuh Sebelumnya:</span>
            <span class="font-medium">1</span>
          </div>
        </div>
        <div class="mt-4 p-3 bg-white dark:bg-gray-800 rounded">
          <div class="text-center">
            <div class="text-3xl font-bold text-red-600">72%</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Risiko Jatuh dalam 6 Bulan</div>
          </div>
        </div>
      </div>
      <div class="text-sm">
        <h6 class="font-semibold mb-1">Rekomendasi AI:</h6>
        <ul class="space-y-1">
          <li>• Program latihan keseimbangan segera</li>
          <li>• Review obat (kurangi benzodiazepines)</li>
          <li>• Asesmen keselamatan di rumah</li>
          <li>• Suplementasi Vitamin D</li>
        </ul>
      </div>
    </div>
  `);
}

function openDrugChecker() {
  showFeatureDemo('Pemeriksa Interaksi Obat Cerdas', `
    <div class="space-y-4">
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-1">Daftar Obat:</label>
          <div class="space-y-2">
            <input type="text" placeholder="Amlodipine 5mg" class="w-full p-2 border rounded" value="Amlodipine 5mg">
            <input type="text" placeholder="Metformin 500mg" class="w-full p-2 border rounded" value="Metformin 500mg">
            <input type="text" placeholder="Simvastatin 20mg" class="w-full p-2 border rounded" value="Simvastatin 20mg">
            <input type="text" placeholder="Tambah obat..." class="w-full p-2 border rounded">
          </div>
        </div>
        <button onclick="checkInteractions()" class="elderly-friendly-btn w-full bg-purple-500 text-white">
          Cek Interaksi
        </button>
      </div>
      <div id="interactionResults" class="hidden">
        <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg">
          <h6 class="font-semibold mb-2 text-yellow-800 dark:text-yellow-200">⚠️ Interaksi Potensial Ditemukan</h6>
          <p class="text-sm">Simvastatin + Amlodipine: Meningkatkan risiko miopati. Pertimbangkan penyesuaian dosis atau alternatif statin.</p>
        </div>
      </div>
    </div>
  `);
}

function checkInteractions() {
  document.getElementById('interactionResults')?.classList.remove('hidden');
}

function openNutritionPlanner() {
  showFeatureDemo('Perencana Nutrisi AI', `
    <div class="space-y-4">
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
          <label class="block font-medium mb-1">Kondisi Medis:</label>
          <div class="space-y-1">
            <label class="flex items-center">
              <input type="checkbox" class="mr-2" checked> Diabetes
            </label>
            <label class="flex items-center">
              <input type="checkbox" class="mr-2" checked> Hipertensi
            </label>
            <label class="flex items-center">
              <input type="checkbox" class="mr-2"> CKD
            </label>
          </div>
        </div>
        <div>
          <label class="block font-medium mb-1">Preferensi Diet:</label>
          <div class="space-y-1">
            <label class="flex items-center">
              <input type="checkbox" class="mr-2"> Vegetarian
            </label>
            <label class="flex items-center">
              <input type="checkbox" class="mr-2" checked> Rendah natrium
            </label>
            <label class="flex items-center">
              <input type="checkbox" class="mr-2"> Halal
            </label>
          </div>
        </div>
      </div>
      <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
        <h6 class="font-semibold mb-2">Rencana Makan Personal:</h6>
        <div class="text-sm space-y-2">
          <div>
            <strong>Sarapan:</strong> Oatmeal dengan beri, susu rendah lemak (300 kal, 45g karbohidrat)
          </div>
          <div>
            <strong>Makan Siang:</strong> Ikan bakar, nasi merah, sayuran kukus (400 kal, 40g karbohidrat)
          </div>
          <div>
            <strong>Makan Malam:</strong> Sup ayam, roti gandum (350 kal, 35g karbohidrat)
          </div>
        </div>
        <div class="mt-3 pt-3 border-t border-green-200 dark:border-green-800">
          <div class="flex justify-between text-sm">
            <span>Total Kalori: 1,050</span>
            <span>Protein: 65g</span>
            <span>Natrium: <1,500mg</span>
          </div>
        </div>
      </div>
    </div>
  `);
}

function startCognitiveTest() {
  showFeatureDemo('Asesmen Kognitif Digital', `
    <div class="space-y-4">
      <div class="text-center">
        <h5 class="font-semibold mb-2">Mini-Mental State Examination (MMSE)</h5>
        <p class="text-sm text-gray-600 dark:text-gray-400">Adaptasi digital dengan penilaian otomatis</p>
      </div>
      <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
        <h6 class="font-semibold mb-2">Contoh Pertanyaan:</h6>
        <p class="mb-3">Silakan ingat 3 kata ini: Apel, Meja, Uang logam</p>
        <button class="elderly-friendly-btn bg-blue-500 text-white">
          Lanjutkan Tes →
        </button>
      </div>
      <div class="text-sm">
        <h6 class="font-semibold mb-1">Komponen Tes:</h6>
        <ul class="space-y-1">
          <li>• Orientasi (waktu & tempat)</li>
          <li>• Registrasi & Recall</li>
          <li>• Perhatian & Kalkulasi</li>
          <li>• Bahasa & Praxis</li>
          <li>• Konstruksi Visual</li>
        </ul>
      </div>
    </div>
  `);
}

function openExerciseCoach() {
  showFeatureDemo('Pelatih Olahraga AI', `
    <div class="space-y-4">
      <div class="bg-teal-50 dark:bg-teal-900/20 p-4 rounded-lg">
        <h6 class="font-semibold mb-2">Program Olahraga Personal</h6>
        <div class="text-sm space-y-2">
          <div class="flex items-center justify-between">
            <span>Tingkat Kebugaran:</span>
            <span class="font-medium">Sedang</span>
          </div>
          <div class="flex items-center justify-between">
            <span>Kondisi:</span>
            <span class="font-medium">Arthritis, Hipertensi</span>
          </div>
          <div class="flex items-center justify-between">
            <span>Tujuan:</span>
            <span class="font-medium">Meningkatkan Keseimbangan</span>
          </div>
        </div>
      </div>
      <div class="space-y-3">
        <div class="border dark:border-gray-700 rounded-lg p-3">
          <h6 class="font-medium mb-1">Minggu 1-2: Fondasi</h6>
          <ul class="text-sm space-y-1">
            <li>• Duduk berdiri: 10 repetisi × 2 set</li>
            <li>• Push-up dinding: 10 repetisi × 2 set</li>
            <li>• Jalan tumit ke jari kaki: 20 langkah</li>
            <li>• Marching duduk: 2 menit</li>
          </ul>
        </div>
        <button class="elderly-friendly-btn w-full bg-teal-500 text-white">
          Mulai Sesi Terbimbing
        </button>
      </div>
    </div>
  `);
}

function openSleepAnalyzer() {
  showFeatureDemo('Analisis & Optimasi Tidur', `
    <div class="space-y-4">
      <div class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-lg">
        <h6 class="font-semibold mb-2">Analisis Pola Tidur</h6>
        <div class="space-y-2">
          <div class="flex justify-between text-sm">
            <span>Durasi Tidur Rata-rata:</span>
            <span class="font-medium text-orange-600">5.5 jam</span>
          </div>
          <div class="flex justify-between text-sm">
            <span>Effisiensi Tidur:</span>
            <span class="font-medium text-orange-600">68%</span>
          </div>
          <div class="flex justify-between text-sm">
            <span>Bangun Malam:</span>
            <span class="font-medium text-red-600">4-5 kali</span>
          </div>
        </div>
      </div>
      <div>
        <h6 class="font-semibold mb-2">Rencana Sleep Hygiene Personal:</h6>
        <ul class="text-sm space-y-1">
          <li>✓ Waktu tidur tetap: 22:00 (optimasi sirkadian)</li>
          <li>✓ Hapus perangkat elektronik 1 jam sebelum tidur</li>
          <li>✓ Suhu kamar: 18-20°C</li>
          <li>✓ Pertimbangkan melatonin 2mg jam 21:00</li>
          <li>✓ Paparan cahaya pagi: 30 menit</li>
        </ul>
      </div>
    </div>
  `);
}

function joinWebinar(topic) {
  alert(`Webinar "${topic}" akan dimulai. Link Zoom akan dikirim ke email terdaftar.`);
}

function openLearningPortal() {
  window.open('#learning', '_blank');
}

function openResource(resourceId) {
  alert(`Membuka sumber: ${resourceId}. Fitur download akan segera tersedia.`);
}

function schedulePoliAppointment(specialty) {
  alert(`Membuka sistem booking untuk Poli ${specialty}. Integrasi dengan sistem RS.`);
}

function openHelp() {
  showFeatureDemo('Pusat Bantuan', `
    <div class="space-y-3">
      <h5 class="font-semibold">Pertanyaan yang Sering Diajukan</h5>
      <div class="space-y-2 text-sm">
        <details class="border dark:border-gray-700 rounded p-2">
          <summary class="cursor-pointer font-medium">Bagaimana cara menggunakan screening geriatri?</summary>
          <p class="mt-2 text-gray-600 dark:text-gray-400">Klik tombol "Screening Geriatri Pro", isi data demografis dan jawab 14 pertanyaan assessment.</p>
        </details>
        <details class="border dark:border-gray-700 rounded p-2">
          <summary class="cursor-pointer font-medium">Apakah data saya aman?</summary>
          <p class="mt-2 text-gray-600 dark:text-gray-400">Ya, semua data terenkripsi end-to-end dan mematuhi standar HIPAA/GDPR.</p>
        </details>
      </div>
    </div>
  `);
}

function openPrivacy() {
  window.open('/privacy', '_blank');
}

function openTerms() {
  window.open('/terms', '_blank');
}

function openAPI() {
  window.open('/api-docs', '_blank');
}

/* ===== PWA FUNCTIONALITY ===== */
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  // Show install button
  const installBtn = document.createElement('button');
  installBtn.id = 'installBtn';
  installBtn.className = 'fixed bottom-4 right-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-2 rounded-full shadow-lg hover:scale-105 transition-all z-40 text-sm flex items-center gap-2';
  installBtn.innerHTML = '<span>📱</span> Install Aplikasi SIGAP';
  installBtn.onclick = async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        installBtn.remove();
        announceToScreenReader('Aplikasi berhasil diinstall');
      }
      deferredPrompt = null;
    }
  };
  
  document.body.appendChild(installBtn);
  
  // Auto-hide after 30 seconds
  setTimeout(() => {
    if (document.getElementById('installBtn')) {
      installBtn.style.transform = 'translateY(100px)';
    }
  }, 30000);
});

/* ===== SERVICE WORKER ===== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    const swCode = `
      const CACHE_NAME = 'sigap-geriatricare-v6.5.0';
      const urlsToCache = [
        '/',
        'https://cdn.tailwindcss.com',
        'https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap',
        'https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js',
        'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js'
      ];
      self.addEventListener('install', (event) => {
        event.waitUntil(
          caches.open(CACHE_NAME)
            .then((cache) => cache.addAll(urlsToCache))
        );
        self.skipWaiting();
      });
      self.addEventListener('activate', (event) => {
        event.waitUntil(
          caches.keys().then((cacheNames) => {
            return Promise.all(
              cacheNames.map((cacheName) => {
                if (cacheName !== CACHE_NAME) {
                  return caches.delete(cacheName);
                }
              })
            );
          })
        );
        self.clients.claim();
      });
      self.addEventListener('fetch', (event) => {
        event.respondWith(
          caches.match(event.request)
            .then((response) => {
              if (response) {
                return response;
              }
              return fetch(event.request).then((response) => {
                if (!response || response.status !== 200 || response.type !== 'basic') {
                  return response;
                }
                const responseToCache = response.clone();
                caches.open(CACHE_NAME).then((cache) => {
                  cache.put(event.request, responseToCache);
                });
                return response;
              });
            })
            .catch(() => {
              return new Response('Offline - Cached content not available', {
                status: 503,
                statusText: 'Service Unavailable',
                headers: new Headers({
                  'Content-Type': 'text/plain'
                })
              });
            })
        );
      });
    `;
    
    const blob = new Blob([swCode], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(blob);
    
    navigator.serviceWorker.register(swUrl)
      .then((registration) => {
        console.log('SIGAP SW registered:', registration.scope);
        
        // Check for updates periodically
        setInterval(() => {
          registration.update();
        }, 3600000); // Every hour
      })
      .catch((error) => {
        console.error('SIGAP SW registration failed:', error);
      });
  });
}

/* ===== EVENT LISTENERS ===== */
document.addEventListener('DOMContentLoaded', () => {
  // Initialize theme and settings
  initializeTheme();
  
  // Initialize 3D game if enabled
  if (CONFIG.FEATURES.THREE_D_GAME) {
    AppState.game3D = new Game3D('gameContainer');
  }
  
  // Add event listeners
  document.getElementById('themeToggle').addEventListener('click', toggleTheme);
  document.getElementById('fontIncrease').addEventListener('click', increaseFontSize);
  document.getElementById('fontDecrease').addEventListener('click', decreaseFontSize);
  document.getElementById('speechToggle').addEventListener('click', toggleSpeech);
  
  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // Escape to close modals
    if (e.key === 'Escape') {
      document.querySelectorAll('.modal').forEach(modal => {
        if (!modal.classList.contains('hidden')) {
          const modalId = modal.id;
          if (modalId === 'screeningModal') closeScreening();
          else if (modalId === 'chatModal') closeChat();
          else if (modalId === 'knowledgeModal') closeKnowledgeBase();
        }
      });
    }
    
    // Ctrl/Cmd + K to open search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      openKnowledgeBase();
      setTimeout(() => {
        document.getElementById('kbSearch')?.focus();
      }, 100);
    }
  });
  
  // Prevent double-tap zoom on mobile
  let lastTouchEnd = 0;
  document.addEventListener('touchend', (event) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      event.preventDefault();
    }
    lastTouchEnd = now;
  }, false);
  
  // Load voices for TTS
  if ('speechSynthesis' in window) {
    speechSynthesis.onvoiceschanged = () => {
      const voices = speechSynthesis.getVoices();
      console.log('Available voices:', voices.length);
    };
  }
  
  // Welcome message
  setTimeout(() => {
    if (AppState.speechEnabled && !sessionStorage.getItem('welcomed')) {
      speakText('Selamat datang di SIGAP GeriatriCare Pro. Platform kesehatan geriatri berbasis AI untuk pelayanan lansia optimal.');
      sessionStorage.setItem('welcomed', 'true');
    }
  }, 2000);
  
  // Analytics (if enabled)
  if (CONFIG.FEATURES.ANALYTICS) {
    console.log('Analytics enabled - tracking user interactions');
  }
  
  console.log(`🏥 SIGAP GeriatriCare Pro v${CONFIG.VERSION} initialized successfully!`);
});

/* ===== PERFORMANCE MONITORING ===== */
if ('PerformanceObserver' in window) {
  const perfObserver = new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
      if (entry.entryType === 'largest-contentful-paint') {
        console.log('LCP:', entry.startTime);
      }
    }
  });
  
  perfObserver.observe({ entryTypes: ['largest-contentful-paint'] });
}

// Monitor memory usage
setInterval(() => {
  if (performance.memory) {
    const memoryUsage = (performance.memory.usedJSHeapSize / 1048576).toFixed(2);
    if (memoryUsage > 50) {
      console.warn(`High memory usage: ${memoryUsage} MB`);
    }
  }
}, 30000);

/* ===== ERROR HANDLING ===== */
window.addEventListener('error', (event) => {
  console.error('Global error:', event.error);
  
  // Send error to analytics if enabled
  if (CONFIG.FEATURES.TELEMETRY) {
    // Error reporting logic
  }
});

window.addEventListener('unhandledrejection', (event) => {
  console.error('Unhandled promise rejection:', event.reason);
});

/* ===== END OF SCRIPT ===== */
</script>
</body>
</html>
